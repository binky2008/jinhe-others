<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>班车考勤汇总</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>
    
    <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable,
        sub,
        tabH,
        EatingBar = 0,
        EatingBar2 = 0,
        EatingPie = 0;

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
        var barcanvas = document.getElementById('barcanvas'),
            bar2canvas = document.getElementById('bar2canvas'),
            bar3canvas = document.getElementById('bar3canvas'),
            piecanvas = document.getElementById('piecanvas');
        
        barcanvas.style.height = (screen.height * 0.9091 - 150) + 'px';
        bar2canvas.style.height = (screen.height * 0.9091 - 150) + 'px';
        bar3canvas.style.height = (screen.height * 0.9091 - 150) + 'px';
        piecanvas.style.height = (screen.height * 0.9091 - 150) + 'px';

        $('#Tab').tabs({border:false,onSelect:function(title){
            if(title == '接件准点率'){
                if(!EatingBar){
                    BarPainting('取件离港');
                }
                EatingBar = 1;
            }

            if(title == '罚款直方图'){
                if(!EatingBar2){
                    BarPainting2();
                }
                EatingBar2 = 1;
            }

            if(title == '罚款占比图'){
                if(!EatingPie){
                    PiePainting();
                }
                EatingPie = 1;
            }
        }}); 

        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            sub = queryParams.param1 + '至' + queryParams.param2;

            BarPainting('交件到港');
            return;
        }
    } 


    function PiePainting(){
    	var originData = globalValiable.data,
            p = {},
            data = {},
            name = [],
            value = [],
            cl = [],
            temp = 0,
            total = 0,
            s = 0;

        p = [];
        for(var i = 0; i < originData.length; i++) {    
            var center = originData[i]["fb"].replace('分拨',''),
                pay = originData[i]["pay"];

            if(p[center] == null){
                p[center] = 0;
            }

            p[center] += pay;
            total += pay;
        }

        for(var c in p){
            if(p[c]/total > 0.03){
                name.push(c);
                value.push(p[c]);
            }
            else if(p[c] > 0){
                temp += p[c];
            }
        }

        data = [];
        while(s < name.length){
            var max = s;
            if(!cl.contains(name[max])){
                for(var i=0;i<name.length;i++){
                    if(!cl.contains(name[i])){
                        if(value[max] < value[i]){
                            max = i;
                        }
                    }
                }
                cl.push(name[max]);
                data.push({name:name[max],value:value[max]});
            }     
            else{
                s++;
            }      
        }
        data.push({name:'其他',value:temp});

        var myChart = echarts.init(document.getElementById('piecanvas'));
///////////////////////////////OPTION
option = {
    title : {
        text: '罚款占比图',
        textStyle:{fontSize:'24',fontFamily:'Microsoft YaHei'},
        subtext: sub,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'left',
        y:'top'
    },
    tooltip : {
        show: true,
        formatter: function(d){
            if(d[1]){
                return d[1]+':'+d[2]+'元('+d[3]+'%)';
            }
            else{
                return '';
            }
        },
        textStyle:{fontSize:'14',color: '#ffffff',fontFamily:'Microsoft YaHei'}
    },
    calculable : true,
    series : [
        {
            name:'罚款',
            type:'pie',
            center : ['50%', '50%'],
            radius : 300,
            itemStyle : {
                normal : {
                    label : {
                        position : 'inner',
                        formatter : function (a,b,c,d) {return b+(d - 0).toFixed(0) + '%'}
                    },
                    labelLine : {
                        show : false
                    }
                },
                emphasis : {
                    label : {
                        show : true,
                        formatter : function (a,b,c,d) {return b+(d - 0).toFixed(0) + '%'}
                    }
                }
                
            },
            data:data
        }
    ]
};

        myChart.setOption(option);
    }

    function BarPainting(Type){
        var originData = globalValiable.data,
            datac = [],
            data = [],
            min = 100;

        for(var i = 0; i < originData.length; i++) {    
            var center = originData[i]["fb"].replace('分拨',''),
                type = originData[i]["type"],
                rate = originData[i]["r"];

            if(type == Type){
                if(!datac.contains(center)){
                    datac.push(center);
                }
  
                data.push(rate); 

                if(rate < min){
                    min = rate;
                }
            }
        }

        min = Math.floor(min/10)*10;

        var myChart;
        if(Type == '交件到港'){
           myChart = echarts.init(document.getElementById('barcanvas'));
        } 
        else{
            myChart = echarts.init(document.getElementById('bar2canvas'));
        }
 ///////////////////////////////////Option
        var option = {
    title : {
        text:Type + '准点率',
        textStyle:{fontSize:'24',color:'#000',fontFamily:'Microsoft YaHei'},
        subtext:sub,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    dataZoom:{
        show : true,
        realtime : true,
        start : 0,
        end : 30,
        dataBackgroundColor:'#fff',
        fillerColor:'#666',
        handleColor:'#666'
    },
    tooltip : {
        trigger: 'axis',
        backgroundColor:'rgba(255,226,141,0.7)',
        textStyle:{fontSize:'16',color:'#000',fontFamily:'Microsoft YaHei'},
        axisPointer:{type:'line',lineStyle:{color: '#FF7F24',width: 1}},
        formatter : function (a,b,c,d) {return a[0][1] + '：' + a[0][2] + '%';}
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#999999'}},
            axisLabel:{
                interval:0,
                textStyle:{color:'#999999',fontSize:'12'}
            },
            data : datac
        }
    ],
    yAxis : [
        {
            name:'百分比',
            type : 'value',
            axisLine:{lineStyle:{color:'#999999'}},
            axisLabel:{textStyle:{color:'#999999',fontSize:'12'}},
            min:min,
            max:100
        }
    ],
    series : [
        {
            name:Type,
            type:'bar',
            data:data,
            itemStyle:{
                normal:{
                    color:'#F2572D',
                    barborderColor:'#F2572D'
                }
            }
        }      
    ]
};            
        myChart.setOption(option);
    }


    function BarPainting2(){
        var originData = globalValiable.data,
            datac = [],
            data = [],
            name = [],
            value = [],
            cl = [],
            p = {},
            min = 100000000,
            max = 0
            s = 0;

        p = [];
        for(var i = 0; i < originData.length; i++) {    
            var center = originData[i]["fb"].replace('分拨',''),
                pay = originData[i]["pay"];

            if(pay > 0){
                if(!cl.contains(center)){
                    cl.push(center);
                    p[center] = 0;
                }
  
                p[center] += pay;
            }
        }

        for(var c in p){
            if(c != 'contains'){
                name.push(c);
                value.push(p[c]);
            }
        }

        cl = [];
        while(s < name.length){
            var maxt = s;
            if(!cl.contains(name[maxt])){
                for(var i=0;i<name.length;i++){
                    if(!cl.contains(name[i])){
                        if(value[maxt] < value[i]){
                            maxt = i;
                        }
                    }
                }
                cl.push(name[maxt]);


                datac.push(name[maxt]);
                data.push(value[maxt]);      

                if(value[maxt] > max){
                    max = value[maxt];
                }

                if(value[maxt] < min){
                    min = value[maxt];
                }
            }     
            else{
                s++;
            }      
        }

        max = Math.ceil(max/100)*100;
        min = Math.floor(min/100)*100;

        var myChart = echarts.init(document.getElementById('bar3canvas'));
 ///////////////////////////////////Option
        var option = {
    title : {
        text:'罚款直方图',
        textStyle:{fontSize:'24',color:'#000',fontFamily:'Microsoft YaHei'},
        subtext:sub,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    dataZoom:{
        show : true,
        realtime : true,
        start : 0,
        end : 30,
        dataBackgroundColor:'#fff',
        fillerColor:'#666',
        handleColor:'#666'
    },
    tooltip : {
        trigger: 'axis',
        backgroundColor:'rgba(255,226,141,0.7)',
        textStyle:{fontSize:'16',color:'#000',fontFamily:'Microsoft YaHei'},
        axisPointer:{type:'line',lineStyle:{color: '#FF7F24',width: 1}},
        formatter : function (a,b,c,d) {return a[0][1] + '：' + a[0][2] + '元';}
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#999999'}},
            axisLabel:{
                interval:0,
                textStyle:{color:'#999999',fontSize:'12'}
            },
            data : datac
        }
    ],
    yAxis : [
        {
            name:'元',
            type : 'value',
            axisLine:{lineStyle:{color:'#999999'}},
            axisLabel:{textStyle:{color:'#999999',fontSize:'12'}},
            min:min,
            max:max
        }
    ],
    series : [
        {
            name:'罚不死你',
            type:'bar',
            data:data,
            itemStyle:{
                normal:{
                    color:'#F2572D',
                    barborderColor:'#F2572D'
                }
            }
        }      
    ]
};            
        myChart.setOption(option);
    }
    </script>

    <style type="text/css">
        dt {font-family:Microsoft YaHei;font-size:20px;}
        dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
    </style>
</head>

<body>
	<div class="easyui-tabs" id='Tab' data-options='fit:true'>
        <div title="交件准点率" id='bar' style="font-family:Microsoft YaHei;font-size:16px;"> 
            <div id='barcanvas' style="height:640px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="接件准点率" id='bar2' style="font-family:Microsoft YaHei;font-size:16px;"> 
            <div id='bar2canvas' style="height:640px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="罚款直方图" id='bar3' style="font-family:Microsoft YaHei;font-size:16px;">
            <div id='bar3canvas' style="height:640px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="罚款占比图" id='Pie' style="font-family:Microsoft YaHei;font-size:16px;">
            <div id='piecanvas' style="height:640px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="说明书" id='TabNotice'>
            <dl>
            <dt>取值逻辑</dt>
            <dd>- 根据当日站点发件扫描、分拨的发件扫描，对比班车考勤，查出交件漏扫、接件漏扫班车。打卡的班车则根据打卡时间、打卡类型，对比规定打卡时间，判断考勤是否延误、计算延误时间和理论处罚金额</dd>
            <dt>时间节点</dt>
            <dd>- 当日14:30至次日14:30</dd>
            <dd>- 按考勤时间计算</dd>
            <dt>注意点</dt>
            <dd>- 由于系统规定考勤时间不带日期格式，和打卡时间对比时会出现如下情况：规定时间是凌晨，打卡时间是前一日晚上，导致打卡时间大于规定时间。故做如下修正：规定时间在0:00到7:59间，打卡时间在18:00~23:59间，认为准时打卡；打卡时间在0:00点到7:59点间，规定时间在18:00~23:59间，认为延误。</dd>
            <dd>- 规定时间在18:00~23:59间，打卡时间在当日0:00点到7:59点间，在提早10个小时打卡的情况下，可能会误判为延误。但是此种情况罕见，几乎没有大的影响</dd>
            <dd>- 数据结果中不包含直客窗口、派送窗口以及各种项目等站点数据</dd>
            </dl>
        </div>
    </div>
</body>
</html>