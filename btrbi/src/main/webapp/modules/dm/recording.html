<!DOCTYPE HTML>
<HTML xmlns:WorkSpace xmlns:Tree xmlns:Grid>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>    
<meta charset="UTF-8">
<title>数据录入</title>

<link href="../../css/css.css" rel="stylesheet">
<link href="../../tools/tssJS/css/tss.all.css" rel="stylesheet">

<script src="../../tools/tssJS/tssJS.all.js"></script>
<script src="../../tools/tssJS/tssJS.json2Form.js"></script>
<script src="../../tools/tssUtils.js"></script>

<style type="text/css">

    #ws {
        width: 40%;
        max-width: 600px;
        min-width: 400px;
        height: 100%;
        position: fixed;
        right: 0;
        top: 1px;
        z-index: 2;
    }

</style>

<SCRIPT type="text/javascript">
<!-- 

/* 后台响应数据节点名称 */
XML_SOURCE_LIST = "RecordData";

/* XMLHTTP请求地址汇总 */
URL_SOURCE_LIST   = AUTH_PATH + "xdata/xml/";
URL_SAVE_SOURCE   = AUTH_PATH + "xdata/";
URL_DELETE_SOURCE = AUTH_PATH + "xdata/";
URL_GET_DEFINES   = AUTH_PATH + "xdata/define/";

var recordId = 1, recordName = "数据录入";

$(function() {
    var globalValiable = window.parent.globalValiable;
    if(globalValiable) {
        recordId   = globalValiable.id;
        recordName = globalValiable.name;

        init();
        return;
    }

    // just Test
    URL_SOURCE_LIST   = "data/data_grid.xml?";
    URL_SAVE_SOURCE   = "data/_success.xml?";
    URL_DELETE_SOURCE = "data/_success.xml?";
    URL_GET_DEFINES   = "data/record_define.json?";

    init();
});

/* 页面初始化 */
function init() {
    initMenus();
    initWorkSpace();

    loadGridData({}, 1); 
    $("#rcTitle").html(recordName + "列表");
}

function initMenus() {
    /* Grid菜单初始化  */
    var item1 = {
        label:"编辑",
        callback: showDetail,
        icon: "images/icon_edit.gif"
    }
    var item2 = {
        label:"删除",
        callback: remove,
        icon: "images/icon_del.gif"
    }
    var item3 = {
        label:"新增",
        callback: function() { showDetail(true); }
    }

    var menu = new $.Menu();
    menu.addItem(item1);
    menu.addItem(item2);
    menu.addItem(item3);
    $1("grid").contextmenu = menu;
}

/* grid加载数据  */
function loadGridData(params, page) {
    $.showGrid(URL_SOURCE_LIST + recordId, XML_SOURCE_LIST, showDetail, "grid", page, params);
}

/* 显示资源详细信息 */
function showDetail(isCreate) {    
    var rowID = isCreate ? '_new' : $.G("grid").getColumnValue("id");  
    var rowName = recordName + rowID;

    var callback = {};
    callback.onTabClose = function(eventObj){
        if( ws.noTabOpend() ) {
            $("#ws").hide();
        }            
    };

    callback.onTabChange = function() {
        setTimeout(function() {
            loadDetailData(rowID);

        }, TIMEOUT_TAB_CHANGE);
    };

    var inf = {};
    inf.label = rowName;
    inf.SID = "viewRow_" + rowID;
    inf.defaultPage = "page1";
    inf.callback = callback;
    var tab = ws.open(inf);   

    $("#ws").show(true);    
}

function loadDetailData(rowID) {
    $.ajax({
        url : URL_GET_DEFINES + recordId,
        ondata: function() {
            var defines = this.getResponseJSON();

            if(rowID != '_new') {
                var grid = $.G("grid");
                defines.each(function(i, field){
                    field.defaultValue = grid.getColumnValue(field.code);
                });
            }
        
            var xform = $.json2Form("page1Form", defines);

            $.cache.XmlDatas[rowID] = xform.template.dataNode;

            attachReminder(rowID, xform); // 离开提醒

            // 设置保存/关闭按钮操作
            $1("page1BtCancel").onclick = function() {
                ws.closeActiveTab();
            }
            $1("page1BtSave").onclick = function() {
                saveSource(rowID);
            }
        }
    });
}

function saveSource(rowID) {
    var xform = $.F("page1Form");  
    if( !xform.checkForm() ) return;

    var request = new $.HttpRequest();
    request.url = URL_SAVE_SOURCE + recordId;

    var dataNode = $.cache.XmlDatas[rowID];
    request.setFormContent(dataNode);

    if(rowID != '_new') {
       request.url += "/" + rowID;
    }

    syncButton([$1("page1BtSave")], request); // 同步按钮状态
    detachReminder(rowID); // 解除提醒

    request.onsuccess = function() { // 更新
        loadGridData({}, $1("GridPageList").value || 1); 
        ws.closeActiveTab();
    }
    request.send();
}

function remove()  { 
    if( !confirm("您确定要删除该行记录吗？") ) return;
        
    var grid = $.G("grid");
    var rowID  = grid.getColumnValue("id");
    if( rowID ) {
        $.ajax({
            url : URL_DELETE_SOURCE + recordId + "/" + rowID,
            method : "DELETE",
            onsuccess : function() { 
                grid.deleteSelectedRow();
            }
        }); 
    }
}

// ------------------------------------------------- 多级下拉选择联动 ------------------------------------------------
/*
 *  多级下拉选择联动
 *  参数： nextIndex    下一级联动参数的序号（1->n）
        serviceID       下一级联动的service地址             
        currParam       当前联动参数的序号
        currParamValue  当前联动参数的值
 */
function getNextLevelOption(nextIndex, serviceID, currParam, currParamValue) {
    if(nextIndex == null || serviceID == null || currParam == null || $.isNullOrEmpty(currParamValue)) return;

    var dreg = /^[1-9]+[0-9]*]*$/;
    var paramElementId = "param" + nextIndex;
 
    var paramName = dreg.test(currParam) ? "param" + currParam : currParam;
    
    // serviceID maybe is ID of record, maybe a serviceUrl
    var url = dreg.test(serviceID) ? '../../display/json/' + serviceID : serviceID;

    $.getNextLevelOption($.F("page1Form"), paramName, currParamValue, url, paramElementId);
}

//-->
</SCRIPT>

</head>

<body>

    <table>
        <tr>
          <td id="gridTitle">
            <span class="icon"></span><span id="rcTitle">资源列表</span>&nbsp;
            <input type="button" class="btStrong" value="新增" id="insertBT" onclick="showDetail(true)"/>&nbsp;
            <input type="button" class="btStrong" value="刷新" id="refreshBT" onclick="loadGridData({}, 1)"/>
            <span class="buttonBox" id="gridToolBar"></span>
          </td>
        </tr>
        <tr>
          <td class="gridContainer"><Grid id="grid"></Grid></td>
        </tr>
    </table>

    <WorkSpace:Box id="ws" class="hiddenWS">
        <WorkSpace:Page id="page1">
            <div id="page1Form" editable="true"></div>
            <WorkSpace:PageStep>
                <br>
                <input type="button" class="btStrong" value="完成" id="page1BtSave"/>&nbsp;
                <input type="button" class="btWeak" value="取消" id="page1BtCancel"/>
            </WorkSpace:PageStep>
        </WorkSpace:Page>
    </WorkSpace:Box>

</body>
</html>