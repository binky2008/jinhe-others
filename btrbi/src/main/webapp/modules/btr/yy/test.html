<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8" />
   <title>班车及时率</title>

   <link href="../../tools/bootstrap/css/bootstrap.css" rel="stylesheet">
   <script src="../../tools/jquery/jquery-1.10.1.min.js"></script>
   <script src="../../tools/bootstrap/js/bootstrap.min.js"></script>

   <script src="../../framework/core.js"></script>
   <script src="../../framework/ajax.js"></script>
   <script src="../../dm/common.js"></script>

   <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

   <script type="text/javascript">
   var globalValiable,
      Type = 1;

///////////////////////////用于查找目标是否存在于数组
   Array.prototype.contains = function(obj) {  
      var i = this.length;  
      while (i--) {  
         if (this[i] === obj) {  
            return true;  
         }  
      }  
      return false;  
   }  

///////////////////////////填充起末时间中间的日期
    function DayTrans(day){
        var res = day.getYear() + 1900 + '/';

        if(day.getMonth() < 11){
            res += '0';
        }
        res += day.getMonth() + 1 + '/' ;

        if(day.getDate() < 10){
            res += '0';
        }
        res += day.getDate();
        return res;
    }

   window.onload = function(){
//////////////////////////调整画布高度
      var   trend = document.getElementById('TrendCanvas');
      trend.style.height = (screen.height - 265) + 'px';

      globalValiable = window.parent.globalValiable;

////////////////////////////下拉框选项填充
      var originData = globalValiable.data,
         queryParams = globalValiable.queryParams,
         CenterList = [],
         CompanyList = [],
         List = document.getElementById("CenterSelect");

      if(queryParams.param3 == undefined){     
         List.options.add(new Option('全网','全网'));
      }

      for(var i = 0; i < originData.length; i++){
         var c = originData[i]["company"],
            n = originData[i]["name"];

         if(!CompanyList.contains(c)){
            CompanyList.push(c);
            List.options.add(new Option(c,c));
         }

         if(!CenterList.contains(n)){
            CenterList.push(n);
            List.options.add(new Option(n,n));
         }
      }

      $("#Tab1").click();
      $("#send").click();
      Painting();
      Table();
   } 

   function Painting(){
      var originData = globalValiable.data,
         queryParams = globalValiable.queryParams,
         DayList = [],
         data = [],
         matrix = [],
         matrix2 = [],
         series = [],
         min = 100,
         max = 0,
         Selected = document.getElementById("CenterSelect").value;

////////////////////////////把起始结束时间填充完整
      var StratDay = new Date(queryParams.param1),
         EndDay = new Date(queryParams.param2);
      DayList.push(DayTrans(StratDay));
      while(StratDay < EndDay){
         StratDay = new Date(StratDay.setDate(StratDay.getDate() + 1));
         DayList.push(DayTrans(StratDay));
      }

////////////////////////////////////数据部分
      for(var d in DayList){
         if(d != 'contains'){
            matrix[DayList[d]] = 0;
            matrix2[DayList[d]] = 0;
         }
      }

      for(var i = 0; i < originData.length; i++){
         var c = originData[i]["company"],
            n = originData[i]["name"],
            d = originData[i]["inday"];

         if((Selected == '全网')||(Selected == c)||(Selected == n)){
            if(Type == 1){
               matrix[d] += originData[i]["sendn"];
               matrix2[d] += originData[i]["sendt"];
            }
            else if(Type ==2){
               matrix[d] += originData[i]["reachn"];
               matrix2[d] += originData[i]["reacht"];
            }
            else{
               matrix[d] += originData[i]["ontimen"];
               matrix2[d] += originData[i]["ontimet"];
            }
         }
      }

      for(var d in DayList){
         if(d != 'contains'){
            var r = Math.round(matrix[DayList[d]]/matrix2[DayList[d]]*1000)/10;
            data.push(r);

            if(r > max){
               max = r;
            }
            if(r < min){
               min = r;
            }
         }
      }

      max = Math.ceil(max/10)*10;
      min = Math.floor(min/10)*10;

/////////////////////////////////添加系列
   var name;
   if(Type == 1){
      name = '发车及时率';
   }
   else if(Type == 2){
      name = '到达及时率';
   }
   else{
      name = '运行及时率';
   }

   series.push({
   name:name,
   type:'line',
   smooth:true,
   data:data,
   symbol:'none',
   itemStyle: {
      normal: {
         lineStyle: {        // 系列级个性化折线样式
            width: 3,
            color:'#337AB7'
         }
     }
   }
   });

/////////////////////////////////画图部分
      var myChart = echarts.init(document.getElementById('TrendCanvas'));

var option = {
    tooltip : {
        trigger: 'axis',
        axisPointer:{type : 'none'},
        textStyle:{fontSize:'16',color:'#fff',fontFamily:'Microsoft YaHei'},
        formatter:function(d){
            var l = d.length,
                result = d[0][1];

            for(var i = 0;i < d.length;i++){
                if(d[i][2] != '-'){
                    result += '<br/>' + d[i][0] + ':' + d[i][2] + '%';
                }
                else{
                    result += '<br/>' + d[i][0] + ':' + '-';
                }
            }

            return result;
        }
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#999'}},
            boundaryGap : false,
            axisLabel:{
                rotate:-30,
                interval:0,
                textStyle:{color:'#999',fontSize:'16'}
            },
            data : DayList
        }
    ],
    yAxis : [
        {
            name:'百分比',
            nameTextStyle:{
                fontSize:'16',
                fontFamily:'Microsoft YaHei'
            },
            type : 'value',
            axisLine:{lineStyle:{color:'#999'}},
            axisLabel:{textStyle:{color:'#999',fontSize:'16'}},
            min:min,
            max:max
        }
    ],
    series : series
};            
       myChart.setOption(option);
    }

    function Repainting(type){
      if(Type != type){
         Type = type;
         Painting();
      }
    }

   function Table(){
      var originData = globalValiable.data,
         data = {},
         data2 = {},
         datasorted = {},
         CenterList = [],
         CompanyList = [];

      data = [];
      data2 = [];
      for(var i = 0; i < originData.length; i++){
        var company = originData[i]["company"],
          center = originData[i]["name"];

        if(!CompanyList.contains(company)){
          CompanyList.push(company);
          data2[company] = {};
          data2[company].company = company;
          data2[company].ontime = 0;
          data2[company].reach = 0;
          data2[company].send = 0;
          data2[company].total = 0;
          data2.length++;
        }

        if(!CenterList.contains(center)){
          CenterList.push(center);   
          data[center] = {};
          data[center].center = center;
          data[center].company = company;
          data[center].send = 0;
          data[center].total = 0;
          data[center].reach = 0;
          data[center].ontime = 0;
          data.length++;
        }

        data[center].send += originData[i]["sendn"];
        data[center].total += originData[i]["sendt"];
        data[center].reach += originData[i]["reachn"];
        data[center].ontime += originData[i]["ontimen"];

        data2[company].send += originData[i]["sendn"];
        data2[company].total += originData[i]["sendt"];
        data2[company].reach += originData[i]["reachn"];
        data2[company].ontime += originData[i]["ontimen"];
      }

//////////////////////////////////排序
      datasorted = [];
      var i = 0;
        cl = [];
      while(i < data.length){
        var min = 1,  
          ct;

        for(var c in CenterList){
          if((c != 'contains')&&(!cl.contains(CenterList[c]))){
            var  rate = data[CenterList[c]].send/data[CenterList[c]].total;
            if(rate <= min){          
              min = rate;
              ct = CenterList[c];
            }
          }
        }

        cl.push(ct);
        datasorted.push(data[ct]);
        i++;
      }

/////////////////////////////////制表
      var table = document.getElementById("tablesummary"),
        deal = [];
      for(var k = 0; k < CompanyList.length; k++){
        var c = CompanyList[k];
        if(!deal.contains(c)){
          deal.push(c);

          var tr = table.insertRow();
          var td1 = tr.insertCell(0);  
          td1.innerText = data2[c].company;
          td1.style.color = '#337AB7';
          td1.id = c;
          var td2 = tr.insertCell(1);  
          td2.innerText = data2[c].total;
          td2.style.color = '#337AB7';
          var td3 = tr.insertCell(2);  
          td3.innerText = data2[c].total - data2[c].send;
          td3.style.color = '#337AB7';
          var td4 = tr.insertCell(3);  
          td4.innerText = Math.round(data2[c].send/data2[c].total*1000)/10+'%';
          td4.style.color = '#337AB7';
          var td5 = tr.insertCell(4);  
          td5.innerText = data2[c].total - data2[c].reach;
          td5.style.color = '#337AB7';
          var td6 = tr.insertCell(5);  
          td6.innerText = Math.round(data2[c].reach/data2[c].total*1000)/10+'%';
          td6.style.color = '#337AB7';
          var td7 = tr.insertCell(6);  
          td7.innerText = data2[c].total - data2[c].ontime;
          td7.style.color = '#337AB7';
          var td8 = tr.insertCell(7);  
          td8.innerText = Math.round(data2[c].ontime/data2[c].total*1000)/10+'%';
          td8.style.color = '#337AB7';

          for(var i = 0; i < CenterList.length; i++){
            if(datasorted[i].company == c){
              var tr = table.insertRow();
              var td1 = tr.insertCell(0);  
              td1.innerText = datasorted[i].center;
              var td2 = tr.insertCell(1);  
              td2.innerText = datasorted[i].total;
              var td3 = tr.insertCell(2);  
              td3.innerText = datasorted[i].total - datasorted[i].send;
              var td4 = tr.insertCell(3);  
              td4.innerText = Math.round(datasorted[i].send/datasorted[i].total*1000)/10+'%';
              var td5 = tr.insertCell(4);  
              td5.innerText = datasorted[i].total - datasorted[i].reach;
              var td6 = tr.insertCell(5);  
              td6.innerText = Math.round(datasorted[i].reach/datasorted[i].total*1000)/10+'%';
              var td7 = tr.insertCell(6);  
              td7.innerText = datasorted[i].total - datasorted[i].ontime;
              var td8 = tr.insertCell(7);  
              td8.innerText = Math.round(datasorted[i].ontime/datasorted[i].total*1000)/10+'%';
            }
          }

/////////////////////////////////添加导航栏
          var nav = document.getElementById("nav");
          nav.innerHTML = nav.innerHTML + '<li class="active"><a href="#'
          + c + '">' + c + '</a></li>';
        }
      }
      var nav = document.getElementById("nav");
        nav.innerHTML = nav.innerHTML + '<li class="active"><a href="#Table">回到顶部↑</a></li>';
   }
   </script>

   <style type="text/css">
      dt {font-family:Microsoft YaHei;font-size:20px;}
      dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
      th {
        color:#999;
        font-style:normal;
      }
      .btn {font-family:Microsoft YaHei;}
      .Tab {font-family:Microsoft YaHei;}
      #CenterSelect {
         font-family:Microsoft YaHei;
         font-size:18px;
         float:right;
         padding:8px;
         color:#999;
         border-color:#fff;
         text-align:right;
      }
/* Custom Styles */
    #nav{
        font-family:Microsoft YaHei;
        text-align: center;
        color:#337AB7;
        width: 140px;
        margin-top: 20px;
        margin-left: 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.067);
    }
    #nav li{
        margin: 0;
        border-top: 1px solid #ddd;
    }
    #nav li:first-child{
        border-top: none;
    }
    #nav li a{
        margin: 0;
        padding: 8px 16px;
        border-radius: 0;
    }
    #nav li.active a, ul.nav-tabs li.active a:hover{
        color: #fff;
        background: #0088cc;
        border: 1px solid #0088cc;
    }
    #nav li:first-child a{
        border-radius: 4px 4px 0 0;
    }
    #nav li:last-child a{
        border-radius: 0 0 4px 4px;
    }
    #nav.affix{
        top: 30px; /* Set the top position of pinned element */
    }
   </style>
</head>

<body>

<ul id="myTab" class="nav nav-tabs">
   <li class="Tab"><a  id='Tab1' href="#Trend" data-toggle="tab">走势图</a></li>
   <li class="Tab"><a href="#Table" data-toggle="tab">数据表</a></li>
   <li class="Tab"><a href="#Notice" data-toggle="tab">说明书</a></li>
</ul>

<div id="myTabContent" class="tab-content">
   <div class="tab-pane fade in active" id="Trend">
      <div class="btn-group" data-toggle="buttons" style="padding:5px;">
         <label class="btn btn-primary" id='send' onclick='Repainting(1)'>
            <input type="radio" name="options" id="option1">发车及时率
         </label>
         <label class="btn btn-primary" id='reach' onclick='Repainting(2)'>
            <input type="radio" name="options" id="option2">到达及时率
         </label>
         <label class="btn btn-primary" id='trans' onclick='Repainting(3)'>
            <input type="radio" name="options" id="option3">运行及时率
         </label>
      </div>  
      <select id="CenterSelect" onchange="Painting()"></select>&nbsp;
      <div id='TrendCanvas' style="height:640px;"></div>
   </div>
   <div class="tab-pane fade" id="Table">
    <div class="col-xs-2">
        <ul id='nav' class="nav nav-tabs nav-stacked" data-spy="affix" data-offset-top="80">
        </ul>
    </div>
    <div class="col-xs-9">
      <table id='tablesummary' class="table table-hover">
       <thead>
          <tr>
             <th>名称</th>
             <th>发车总次数</th>
             <th>未及时发车</th>
             <th>发车及时率</th>
             <th>未及时到达</th>
             <th>到达及时率</th>
             <th>运行时效未达成</th>
             <th>运行时效达成率</th>
          </tr>
       </thead>
       <tbody>
       </tbody>
    </table>
  </div>
   </div>
   <div class="tab-pane fade" id="Notice">
      <dl>
      <dt>取值逻辑</dt>
      <dd>- 根据当天的实际发车时间，寻找其对应计划发车时间、计划到达时间和实际到达时间。</dd>
      <dd>- 若实际发车时间晚于计划发车时间，则未及时发车，反之及时</dd>
      <dd>- 若实际到达时间晚于计划到达时间，则未及时到达，反之及时</dd>
      <dd>- 若实际到达时间与实际发车时间之差大于计划到达时间与实际到达时间之差，则运行时效未达成，反之达成</dd>
      <dt>时间节点</dt>
      <dd>- 当日16:00AM至次日16:00AM</dd>
      <dd>- 按实际发车时间计</dd>
      <dt>注意点</dt>
      <dd>- 延误10分钟以内予以免除</dd>
      </dl>
   </div>
</div>

</body>
</html>         