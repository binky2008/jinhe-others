<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>装载率树</title>

	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../../dm/common.css">

	<script src="../../tools/easyui/jquery.min.js"></script>
	<script src="../../tools/easyui/jquery.easyui.min.js"></script>

	<script src="../../framework/core.js"></script>
	<script src="../../framework/ajax.js"></script>
	<script src="../../dm/common.js"></script>

	<script type="text/javascript">
	window.onload = function() {
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;

            if(queryParams.param3 == '-1'){
                show(globalValiable.data,true,true);
            }
            else if(queryParams.param4 == '-1'){
                show(globalValiable.data,false,true);
            }
            else{
            	show(globalValiable.data,false,false);
            }
            return;
        }
    } 
	function show(originData,Net,Org){ 
		var CenterList = [],CompanyList = [],TCenterList = [],
			PlateList = [],Relate = [],DayList = [],MyData = [],
			cHtml = [],RowNo = 1,data = {rows:[],footer:[]};

		/////////////原始数据读取
		MyData['全网'] = [];
		MyData['全网']['累计'] = {w:0,lw:0};
		for(var i = 0;i < originData.length;i++){
			var center_in = originData[i]["center_in"],
				center_out = originData[i]["center_out"],
				org_in = originData[i]["org_in"],
				plate = originData[i]["plate"],
				inday = originData[i]["inday"],
				w = originData[i]["w"],
				lw = originData[i]["lw"],
				RouteCenter,RoutePlate;

			//////////////////建立各级关系，数据初始化
			if(!CompanyList.contains(org_in)){
				CompanyList.push(org_in);
				MyData[org_in] = [];
			}
			if(!CenterList.contains(center_in)){
				CenterList.push(center_in);
				Relate[center_in] = org_in;
				MyData[center_in] = [];
			}
			RouteCenter = center_in.replace('分拨','') + '→' + center_out.replace('分拨','');
			if(!TCenterList.contains(RouteCenter)){
				TCenterList.push(RouteCenter);
				Relate[RouteCenter] = center_in;
				MyData[RouteCenter] = [];
			}
			RoutePlate = center_in + center_out + '>' + plate;
			if(!PlateList.contains(RoutePlate)){
				PlateList.push(RoutePlate);
				Relate[RoutePlate] = RouteCenter;
				MyData[RoutePlate] = [];
			}
			if(!DayList.contains(inday)){
				DayList.push(inday);
				MyData['全网'][inday] = {w:0,lw:0};
			}
			if(MyData[org_in][inday] == undefined){
				MyData[org_in][inday] = {w:0,lw:0};
			}
			if(MyData[center_in][inday] == undefined){
				MyData[center_in][inday] = {w:0,lw:0};
			}
			if(MyData[RouteCenter][inday] == undefined){
				MyData[RouteCenter][inday] = {w:0,lw:0};
			}
			if(MyData[RoutePlate][inday] == undefined){
				MyData[RoutePlate][inday] = {w:0,lw:0};
			}
			if(MyData[org_in]['累计'] == undefined){
				MyData[org_in]['累计'] = {w:0,lw:0};
			}
			if(MyData[center_in]['累计'] == undefined){
				MyData[center_in]['累计'] = {w:0,lw:0};
			}
			if(MyData[RouteCenter]['累计'] == undefined){
				MyData[RouteCenter]['累计'] = {w:0,lw:0};
			}
			if(MyData[RoutePlate]['累计'] == undefined){
				MyData[RoutePlate]['累计'] = {w:0,lw:0};
			}

			////////////////添加数据
			MyData[org_in][inday].w += w;
			MyData[org_in][inday].lw += lw;
			MyData[center_in][inday].w += w;
			MyData[center_in][inday].lw += lw;
			MyData[RouteCenter][inday].w += w;
			MyData[RouteCenter][inday].lw += lw;
			MyData[RoutePlate][inday].w += w;
			MyData[RoutePlate][inday].lw += lw;

			MyData[org_in]['累计'].w += w;
			MyData[org_in]['累计'].lw += lw;
			MyData[center_in]['累计'].w += w;
			MyData[center_in]['累计'].lw += lw;
			MyData[RouteCenter]['累计'].w += w;
			MyData[RouteCenter]['累计'].lw += lw;
			MyData[RoutePlate]['累计'].w += w;
			MyData[RoutePlate]['累计'].lw += lw;

			MyData['全网'][inday].w += w;
			MyData['全网'][inday].lw += lw;
			MyData['全网']['累计'].w += w;
			MyData['全网']['累计'].lw += lw;
		}

		//////////////////缺失数据缺省值设定
		DayList.push('累计');
		for(var d in DayList){
			if(d != 'contains'){
				if(MyData['全网'][DayList[d]] == undefined){
					MyData['全网'][DayList[d]] = '';
				}
				else{
					MyData['全网'][DayList[d]] = Rate(MyData['全网'][DayList[d]]);
				}

				for(var c in CompanyList){
					if(c != 'contains'){
						if(MyData[CompanyList[c]][DayList[d]] == undefined){
							MyData[CompanyList[c]][DayList[d]] = '';
						}
						else{
							MyData[CompanyList[c]][DayList[d]] = Rate(MyData[CompanyList[c]][DayList[d]]);
						}
					}
				}

				for(var c in CenterList){
					if(c != 'contains'){
						if(MyData[CenterList[c]][DayList[d]] == undefined){
							MyData[CenterList[c]][DayList[d]] = '';
						}
						else{
							MyData[CenterList[c]][DayList[d]] = Rate(MyData[CenterList[c]][DayList[d]]);
						}
					}
				}

				for(var c in TCenterList){
					if(c != 'contains'){
						if(MyData[TCenterList[c]][DayList[d]] == undefined){
							MyData[TCenterList[c]][DayList[d]] = '';
						}
						else{
							MyData[TCenterList[c]][DayList[d]] = Rate(MyData[TCenterList[c]][DayList[d]]);
						}
					}
				}

				for(var c in PlateList){
					if(c != 'contains'){
						if(MyData[PlateList[c]][DayList[d]] == undefined){
							MyData[PlateList[c]][DayList[d]] = '';
						}
						else{
							MyData[PlateList[c]][DayList[d]] = Rate(MyData[PlateList[c]][DayList[d]]);
						}
					}
				}
			}
		}	

		//////////////////制表数据
		if(Net){
			var temp = MyData['全网'];
	        temp.name = '全网';
	        data.footer.push(temp);
	    }

		for(var o in CompanyList){
			var org = CompanyList[o];
			if(o != 'contains'){
				if(Org){
					var temp = MyData[org];
	                    pre_id = RowNo;

	                temp.name = org;
	                temp.id = RowNo++;
	                temp.state = 'closed';
	                data.rows.push(temp);
	            }

                for(var c in CenterList){
                	var cen = CenterList[c];
                    if((c != 'contains')&&(Relate[cen] == org)){
                        var temp = MyData[cen],
                        	pre_id2 = RowNo;

                        temp.name = cen;
                        temp.id = RowNo++;
                		temp.state = 'closed';
                        if(Org){temp._parentId = pre_id;}
                        data.rows.push(temp);

                        for(var tc in TCenterList){
                        	var tcen = TCenterList[tc];
                        	if((tc != 'contains')&&(Relate[tcen] == cen)){
                        		var temp = MyData[tcen],
                        			pre_id3 = RowNo;
              
		                        temp.name = tcen;
		                        temp.id = RowNo++;
		                        temp.state = 'closed';
		                        temp._parentId = pre_id2;
		                        data.rows.push(temp);

		                        for(var p in PlateList){
		                        	var Plate = PlateList[p];
		                        	if((p != 'contains')&&(Relate[Plate] == tcen)){
		                        		var temp = MyData[Plate];
		              
				                        temp.name = Plate.substr(Plate.indexOf('>') + 1);
				                        temp.id = RowNo++;
				                        temp._parentId = pre_id3;
				                        data.rows.push(temp);
		                        	}
		                        }
                        	}
                        }
                    }
                }
			}
		}

		///////////////添加列
		for(var d in DayList){
			if(d != 'contains'){
				if(DayList[d] == '累计'){
					cHtml.push('<th field="' + DayList[d] + '" width="90" align="right" formatter="formatter" styler="stylerII">' + DayList[d] + '</th>');
				}
				else{
					cHtml.push('<th field="' + DayList[d] + '" width="90" align="right" formatter="formatter" styler="styler">' + DayList[d] + '</th>');
				}
			}
		}
		$$("cityColumn").innerHTML = cHtml.join("\n");

		///////////////////绘制表格
		$('#Tree').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }
       
	Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    function Rate(v){
    	if(v.lw == 0){
    		return '';
    	}
    	else{
    		return v.w/v.lw;
    	}
    }

    function stylerII(value,row,index){
    	if(value < 0.4){
    		return 'color:#C70B25;font-weight:bold;background:#F3F0CD;';
    	}
    	else if(value < 0.7){
    		return 'color:#F28705;font-weight:bold;background:#F3F0CD;';
    	}
    	else if(value < 1.5){
    		return 'color:#389562;font-weight:bold;background:#F3F0CD;';
    	}
    	else{
    		return 'color:#000;font-weight:bold;background:#F3F0CD;';
    	}
	}

    function styler(value,row,index){
    	if(value < 0.4){
    		return 'color:#C70B25;font-weight:bold;';
    	}
    	else if(value < 0.7){
    		return 'color:#F28705;font-weight:bold;';
    	}
    	else if(value < 1.5){
    		return 'color:#389562;font-weight:bold;';
    	}
    	else{
    		return 'color:#000;font-weight:bold;';
    	}
	}

    function formatter(value, row, index){
    	if(value == ''){
    		return '';
    	}
		else if(value > 1.5){
			return formatMoney(value*100, 1) + '%(注意)';
		}
		else{
			return formatMoney(value*100, 1) + '%';
		}
	}

	function formatMoney(s, n) {   
	   n = n > 0 && n <= 20 ? n : 2;   
	   s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
	   var l = s.split(".")[0].split("").reverse(),   
	   r = s.split(".")[1];   
	   t = "";   
	   for(i = 0; i < l.length; i ++ ) {   
	      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
	   }   
	   return t.split("").reverse().join("") + "." + r;   
	} 
	</script>
</head>

<body>
	<table id="Tree" data-options='fit:true'>
        <thead frozen="true">
            <tr>
                <th field="name" width="200">名称</th>
            </tr>
        </thead>
        <thead>
            <tr id="cityColumn"></tr>
        </thead>
    </table>
</body>
</html>