<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>车辆运行示意图</title>

    <link rel="stylesheet" type="text/css" href="../../dm/common.css">
    <link href="../../tools/bootstrap/css/buttons.css" rel="stylesheet">
    <link href="../../tools/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../tools/bootstrap/datatable/jquery.dataTables.min.css" rel="stylesheet">

    <script src="../../tools/jquery/jquery-2.1.3.min.js"></script>
    <script src="../../tools/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../tools/bootstrap/datatable/jquery.dataTables.min.js"></script>
    <script src="../../tools/jquery/ZeroClipboard.js"></script>
    <script src="../../tools/echarts-2.0.4/echarts-plain-map.js"></script>
    <script src="../zk/CityLocation.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable,
        CenterList = [],
        MapTypeA = true,MapTypeB = true,MapTypeC = true;

    window.onload = function() {
        var originData = globalValiable.data,
            List = document.getElementById("CenterList"),
            List2 = document.getElementById("CenterList2"),
            MyMap = document.getElementById('Map');
        MyMap.style.height = (screen.height - 235) + 'px';

        for(var i = 0; i < originData.length; i++){
            var sc = originData[i]["center_in"],
                ec = originData[i]["center_out"];
               
            if(!CenterList.contains(sc)){
                CenterList.push(sc);
                List.options.add(new Option(sc,sc));
                List2.options.add(new Option(sc,sc));
            }
            if(!CenterList.contains(ec)){
                CenterList.push(ec);
                List.options.add(new Option(ec,ec));
                List2.options.add(new Option(ec,ec));
            }
        }

        Table();
        $("#Tab1").click();
    } 

    function Table(){
        var originData = globalValiable.data,
            selected = document.getElementById('CenterList2').value,
            table = document.getElementById("RouteTable"),
            level = 1,count = 0,matrix = [],
            JobList = [],tempdata = [],
            ColorList = ['#999','#337AB7'],
            AlignList = ['right','left'];

        table.innerHTML='';
        for(var i = 0; i < originData.length; i++){
            var cin = originData[i]["center_in"],
                cout = originData[i]["center_out"],
                no = originData[i]["stop_seq"],
                st = originData[i]["start_time"],
                rt = originData[i]["reach_time"],
                job_id = originData[i]["trs_job_id"];

            if((cin == selected)||(cout == selected)){
                if(!JobList.contains(job_id)){
                    JobList.push(job_id);
                    tempdata[job_id] = []; 
                }
            }
        }

        for(var i = 0; i < originData.length; i++){
            var cin = originData[i]["center_in"],
                cout = originData[i]["center_out"],
                no = originData[i]["stop_seq"],
                st = originData[i]["start_time"],
                rt = originData[i]["reach_time"],
                lw = originData[i]["load_weight"],
                lp = originData[i]["license_plate"],
                job_id  = originData[i]["trs_job_id"];

            if(JobList.contains(job_id)){
                tempdata[job_id].push({no:no,sc:cin,ec:cout,st:st,rt:rt,lp:lp,lw:lw});
            }
        }

        for(var j in JobList){
            if(j != 'contains'){
                if(tempdata[JobList[j]].length>level){
                    level = tempdata[JobList[j]].length;
                }
                
                for(var i = 0;i < tempdata[JobList[j]].length;i++){
                    var temp = tempdata[JobList[j]][i];

                    if(i == 0){
                        matrix[count] = [];
                        matrix[count + 1] = [];
                        matrix[count][0] = temp.lp;
                        matrix[count + 1][0] = temp.lw;
                        matrix[count][1] = temp.sc + '分拨';
                        matrix[count + 1][1] = '';
                    }

                    matrix[count][2 * i + 2] = '→';
                    matrix[count][2 * i + 3] = temp.ec + '分拨';        
                    matrix[count + 1][2 * i + 2] = temp.st;
                    matrix[count + 1][2 * i + 3] = temp.rt;
                }

                count += 2;
            }
        }

        level = 2 * level + 2;
        for(var j = 0;j < matrix.length;j++){
            var tr = table.insertRow();

            var td = tr.insertCell(0);
            td.innerText = matrix[j][0];
            td.style.textAlign = 'left';
            td.style.color = ColorList[0];
            for(var i = 1;i < matrix[j].length;i++){
                var td = tr.insertCell(i);
                td.innerText = matrix[j][i];
                td.style.textAlign = AlignList[(i + 1) % 2];
                td.style.color = ColorList[(j + 1) % 2];
            }

            for(var i = matrix[j].length;i < level;i++){
                var td = tr.insertCell(i);
                td.innerText = '';
            }
        }
    }

    function Map(){
        var originData = globalValiable.data,
            selected = document.getElementById('CenterList').value,
            datar = [[],[],[]],datapoint = [],cList = [],cList2 = [],
            tip = [],JobList = [],Relate = [],geoCoord = CityLocation(),
            ColorList = ['#00FF12','#FF259F','#FFEF51'];

        for(var i = 0; i < originData.length; i++){
            var cin = originData[i]["center_in"],
                cout = originData[i]["center_out"],
                job_id  = originData[i]["trs_job_id"],
                sc = originData[i]["start_center"],
                ec = originData[i]["end_center"];

            if((MapTypeA)&&(sc == selected)){
                if(!JobList.contains(job_id)){
                    JobList.push(job_id);
                    Relate[job_id] = 0;
                }
            }
            if((MapTypeB)&&(ec == selected)){
                if(!JobList.contains(job_id)){
                    JobList.push(job_id);
                    Relate[job_id] = 1;
                }
            }
            if((sc != selected)&&(ec != selected)&&((cin == selected)||(cout == selected))&&(MapTypeC)){
                if(!JobList.contains(job_id)){
                    JobList.push(job_id);
                    Relate[job_id] = 2;
                }
            }
        }
   
        for(var i = 0; i < originData.length; i++){
            var cin = originData[i]["center_in"],
                cout = originData[i]["center_out"],
                st = originData[i]["start_time"],
                rt = originData[i]["reach_time"],
                rou = originData[i]["route_name"] + '(' + originData[i]["license_plate"] + ')',
                job_id = originData[i]["trs_job_id"];

            if(JobList.contains(job_id)){
                if(!cList.contains(cin)){
                    cList.push(cin);
                    tip[cin] = [];
                    datapoint.push({name: cin,value:cin});
                }
                if(!cList2.contains(cout)){
                    cList2.push(cout);
                    datapoint.push({name: cout,value:cout});
                }
                if(tip[cin][cout] == undefined){
                    tip[cin][cout] = [];
                }
                tip[cin][cout].push({route:rou,st:ShortDate(st),rt:ShortDate(rt)});

                datar[Relate[job_id]].push([{name:cin},{name: cout,value: st + '~' + rt}]);
            }   
        }

        var series = [{
            name: '全国',
            type: 'map',
            roam: true,
            hoverable: false,
            mapType: 'china',
            itemStyle:{
                normal:{
                    borderColor:'rgba(0,138,186,0.9)',
                    borderWidth:1,
                    areaStyle:{
                        color: '#262126'
                    }
                }
            },
            data:[],
            markLine : {
                smooth:true,
                symbol: ['none', 'circle'],  
                symbolSize : 1,
                itemStyle : {
                    normal: {
                        color:'#fff',
                        borderWidth:1,
                        borderColor:'rgba(30,144,255,0.5)'
                    }
                },
                data : [],
            },
            geoCoord: geoCoord
        }];
        for(var i = 0;i < 3;i++){
            series.push({
                name: 'Level' + i,
                type: 'map',
                mapType: 'china',
                data:[],
                markLine : {
                    smooth:true,
                    effect : {
                        show: true,
                        scaleSize: 1,
                        period: 30,
                        color: '#fff',
                        shadowBlur: 10
                    },
                    itemStyle : {
                        normal: {
                            borderWidth:1,
                            color:ColorList[i],
                            lineStyle: {
                                type: 'solid',
                                shadowBlur: 10
                            }
                        },
                        emphasis:{
                            color:ColorList[i]
                        }
                    },
                    data : datar[i]
                },
                markPoint : {
                    symbol:'emptyCircle',
                    symbolSize :3,
                    effect : {
                        show:true,
                        shadowBlur : 0
                    },
                    itemStyle:{
                    normal:{
                        color:'#fff8dc',
                        label:{
                            show:false
                        }
                    },
                    emphasis:{
                        color:'#FFFA40',
                        label:{
                            show:false
                        }
                    }
                },
                    data : datapoint
                }
            });
        }

        var myChart = echarts.init(document.getElementById('Map'));

var option = {
    backgroundColor: '#262126',
    tooltip : {
        textStyle:{color:'#E8C446',fontSize:'14',fontFamily:'Microsoft YaHei'},
        trigger: 'item',
        formatter: function (v) {
            if(v[1].indexOf('>') >= 0){
                var str = '',
                    cin = v[1].substr(0,v[1].indexOf('>') - 1),
                    cout =v[1].substr(v[1].indexOf('>') + 2,v[1].length - v[1].indexOf('>') - 1);
                
                if(tip[cin] != undefined){
                    if(tip[cin][cout] != undefined){
                        str += cin + '>>>' + cout;
                        for(var i = 0;i< tip[cin][cout].length;i++){
                            str += '</br>' + tip[cin][cout][i].route + '</br>发车:' + tip[cin][cout][i].st + '</br>到达:' + tip[cin][cout][i].rt;
                        }
                    }
                }
                if(tip[cout] != undefined){
                    if(tip[cout][cin] != undefined){
                        str += '</br></br>' + cout + '>>>' + cin;
                        for(var i = 0;i< tip[cout][cin].length;i++){
                            str += '</br>' + tip[cout][cin][i].route + '</br>发车:' + tip[cout][cin][i].st + '</br>到达:' + tip[cout][cin][i].rt;
                        }
                    }
                }
                return str;
            }
            else{
                return v[1];
            }
        }
    },
    series : series
};         
        myChart.setOption(option);
    }

    function ShortDate(v){
        if(v == null){
            return '';
        }
        else{
            return v.substr(v.indexOf('/') + 1);
        }
    }

    function MapSet(v){
        if(v == 1){
            var b = document.getElementById('btn1');
            if(MapTypeA){
                MapTypeA = false;
                b.innerHTML= '<span class="glyphicon glyphicon-remove"></span>始发车线';
            }
            else{
                MapTypeA = true;
                b.innerHTML= '<span class="glyphicon glyphicon-ok"></span>始发车线';
            }
        }
        else if(v ==2){
            var b = document.getElementById('btn2');
            if(MapTypeB){
                MapTypeB = false;
                b.innerHTML= '<span class="glyphicon glyphicon-remove"></span>目的车线';
            }
            else{
                MapTypeB = true;
                b.innerHTML= '<span class="glyphicon glyphicon-ok"></span>目的车线';
            }
        }
        else{
            var b = document.getElementById('btn3');
            if(MapTypeC){
                MapTypeC = false;
                b.innerHTML= '<span class="glyphicon glyphicon-remove"></span>途径车线';
            }
            else{
                MapTypeC = true;
                b.innerHTML= '<span class="glyphicon glyphicon-ok"></span>途径车线';
            }
        }
        ResetMap(false);
    }

    function ResetMap(v){
        if(v){
            var b = document.getElementById('Reset');
            b.innerHTML = '<span class="glyphicon glyphicon-repeat"></span>重置';
            MapTypeA = true;
            MapTypeB = true;
            MapTypeC = true;
            document.getElementById('btn1').innerHTML= '<span class="glyphicon glyphicon-ok"></span>始发车线';
            document.getElementById('btn2').innerHTML= '<span class="glyphicon glyphicon-ok"></span>目的车线';
            document.getElementById('btn3').innerHTML= '<span class="glyphicon glyphicon-ok"></span>途径车线';
        }

        Map();
    }

    function Rate(n,tn){
        if((tn != null)||(tn == 0)){
            return Math.round(n/tn*1000)/10 + '%';
        }
        else{
            return '';
        }
    }

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  
    </script>

    <style type="text/css">
        img {max-height: 100%;}
        dt {font-family:Microsoft YaHei;font-size:20px;}
        dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
        li {font-family:Microsoft YaHei;}
        th {
            color:#999;
            font-family:Microsoft YaHei;
            font-style:normal;
        }
        td{font-family:Microsoft YaHei;}
        span {width:16px;height:16px;}
        .modal-title{font-family:Microsoft YaHei;color:#337AB7;}
        .panel-heading {font-family:Microsoft YaHei;}
        .table-hover{margin-top: 15px;}
        .btn {font-family:Microsoft YaHei;}
        .copybtn {
            font-family:Microsoft YaHei;
            width:140px;
            margin-top: 3px;
        }
        .Tab {font-family:Microsoft YaHei;}
        .navcustom{
            font-family:Microsoft YaHei;
            text-align: center;
            color:#337AB7;
            width: 140px;
            margin-top: 5px;
            margin-left: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.067);
        }
        #CenterList {
            font-family:Microsoft YaHei;
            font-size:16px;
            float:right;
            padding:3px;
            color:#fff8dc;
            display:inline-block;
            border-color:#999;
            background-color:#262126;
            text-align:right;
            margin-top: 1px;
        }
        #CenterList2 {
            font-family:Microsoft YaHei;
            font-size:16px;
            padding:3px;
            color:#337AB7;
            display:inline-block;
            border-color:#999;
            background-color:#fff;
            text-align:right;
            margin-top: 1px;
        }
        #CenterList option:hover { 
            background-color: #f80; 
            color: #fff; 
        }
        #CenterList2 option:hover { 
            background-color: #fff; 
            color: #999; 
        }
/*//////////////////////////////////////Bootstrap Style*/
        .navcustom li{
            margin: 0;
            border-top: 1px solid #ddd;
        }
        .navcustom li:first-child{
            border-top: none;
        }
        .navcustom li a{
            margin: 0;
            padding: 8px 16px;
            border-radius: 0;
        }
        .navcustom li.active a, ul.nav-tabs li.active a:hover{
            color: #fff;
            background: #0088cc;
            border: 1px solid #0088cc;
        }
        .navcustom li:first-child a{
            border-radius: 4px 4px 0 0;
        }
        .navcustom li:last-child a{
            border-radius: 0 0 4px 4px;
        }
        .navcustom.affix{
            top: 30px; /* Set the top position of pinned element */
        }
    </style>
</head>

<body>
<ul id="myTab" class="nav nav-tabs">
    <li class="Tab"><a id='Tab1' href="#TabTable" data-toggle="tab">路由</a></li>
    <li class="Tab"><a href="#TabMap" data-toggle="tab">地图</a></li>
</ul> 
<div class="tab-content">
    <div id="TabMap" class="tab-pane fade" style="background:#262126">
        <button type="button" id="btn1" onclick="MapSet(1)" class="btn btn-success mb">
            <span class="glyphicon glyphicon-ok"></span>始发车线
        </button>
        <button type="button" id="btn2" onclick="MapSet(2)" class="btn btn-success mb">
            <span class="glyphicon glyphicon-ok"></span>目的车线
        </button>
        <button type="button" id="btn3" onclick="MapSet(3)" class="btn btn-success mb">
            <span class="glyphicon glyphicon-ok"></span>途径车线
        </button>
        <button type="button" id="Reset" onclick="ResetMap(true)" class="btn btn-success mb">
            生成<span class="glyphicon glyphicon-send"></span></button>
        <select id="CenterList" onchange="ResetMap()"></select>
        <div id="Map" style="height:640px;"></div>
    </div>
    <div id="TabTable" class="tab-pane fade">
        <select id="CenterList2" onchange="Table()"></select>
        <table id="RouteTable" class="table table-hover">
        </table>
    </div>
</div>
</body>
</html>