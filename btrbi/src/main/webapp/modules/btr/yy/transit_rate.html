<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>中转率</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>

    <script type="text/javascript">

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            sub = queryParams.param1 + '至' + queryParams.param2;
            if(queryParams.param3 == undefined){
                show(globalValiable.data,'全网');
            }
            else{
                show(globalValiable.data,'总计');
            }
            return;
        }
    } 

    function show(originData,total) {    
        var dayList = [];  
        var dataMap = {};  
        var dataMap2 = {};   
        var dataMap3 = {};  
        var dataMap4 = {};
        var dataMap5 = {};  
        var dataMap6 = {};  

        for(var i = 0; i < originData.length; i++) {
            var day = originData[i]["inday"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }

            var r = originData[i]["routine"].replace('分拨','').replace('分拨','');
            if(dataMap[r] == null) {
                 dataMap[r] = [];                 
            }
            if(dataMap2[r] == null) {
                 dataMap2[r] = [];                 
            }
            dataMap[r][day] = originData[i]["sum"];
            dataMap2[r][day] = originData[i]["count"];

            var center = originData[i]["r"].replace('分公司','').replace('分公司','');
            dataMap[r].parents = center;

            if(dataMap3[center] == null) {
                 dataMap3[center] = [];                 
            }
            if(dataMap4[center] == null) {
                 dataMap4[center] = [];                 
            }

            if(dataMap3[center][day] == null){
                dataMap3[center][day] = originData[i]["sum"];
                dataMap4[center][day] = originData[i]["count"];
            }
            else{
                dataMap3[center][day] += originData[i]["sum"];
                dataMap4[center][day] += originData[i]["count"];
            }

            var company = originData[i]["p"];
            dataMap3[center].parents = company;

            if(dataMap5[company] == null) {
                 dataMap5[company] = [];                 
            }
            if(dataMap6[company] == null) {
                 dataMap6[company] = [];                 
            }

            if(dataMap5[company][day] == null){
                dataMap5[company][day] = originData[i]["sum"];
                dataMap6[company][day] = originData[i]["count"];
            }
            else{
                dataMap5[company][day] += originData[i]["sum"];
                dataMap6[company][day] += originData[i]["count"];
            }

            if(dataMap5[total] == null) {
                 dataMap5[total] = [];                 
            }
            if(dataMap6[total] == null) {
                 dataMap6[total] = [];                 
            }

            if(dataMap5[total][day] == null){
                dataMap5[total][day] = originData[i]["sum"];
                dataMap6[total][day] = originData[i]["count"];
            }
            else{
                dataMap5[total][day] += originData[i]["sum"];
                dataMap6[total][day] += originData[i]["count"];
            }
        }

        for(var center in dataMap){
            for(var i=0;i<dayList.length;i++){
                if(dataMap[center][dayList[i]] == undefined){
                    dataMap[center][dayList[i]] = null;
                }
            }
        }

        for(var center in dataMap3){
            for(var i=0;i<dayList.length;i++){
                if(dataMap3[center][dayList[i]] == undefined){
                    dataMap3[center][dayList[i]] = null;
                }
            }
        }

        for(var center in dataMap5){
            for(var i=0;i<dayList.length;i++){
                if(dataMap5[center][dayList[i]] == undefined){
                    dataMap5[center][dayList[i]] = null;
                }
            }
        }

        dayList[dayList.length] = '累计';
        var cHtml = [];       
        for(var i=0; i < dayList.length; i++) {         
            if (i<dayList.length-1){
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
            }
            else{
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">累计</th>');
            }
        }
        
        $$("cityColumn").innerHTML = cHtml.join("\n");

        
        var data = {};
        data.rows = [];
        data.footer = [];
        for(var center in dataMap) {
             var row = {};
             var k = 0;
             var t = 0;
             var t1;
             var t2;
             row.name = center;     
             for(var i = 0; i < dayList.length; i++) {
                if(dataMap[center][dayList[i]] == null){
                    row[dayList[i]] = '';
                    t1 = 0;
                    t2 = 0;
                }
                else{
                    row[dayList[i]] = dataMap[center][dayList[i]]/dataMap2[center][dayList[i]] || 0;
                    t1 = (dataMap[center][dayList[i]] || 0);
                    t2 = (dataMap2[center][dayList[i]] || 0);
                }
                 
                if(i == dayList.length-1){
                    row[dayList[i]] = k/t;
                }
                else{
                    k = k + t1;
                    t = t + t2;
                }
             }
             data.rows.push(row);      
        }

        for(var center in dataMap3) {
             var row = {};
             var k = 0;
             var t = 0;
             var t1;
             var t2;
             row.name = center;          
             for(var i = 0; i < dayList.length; i++) {
                if(dataMap3[center][dayList[i]] == null){
                    row[dayList[i]] = '';
                    t1 = 0;
                    t2 = 0;
                }
                else{
                    row[dayList[i]] = dataMap3[center][dayList[i]]/dataMap4[center][dayList[i]] || 0;
                    t1 = (dataMap3[center][dayList[i]] || 0);
                    t2 = (dataMap4[center][dayList[i]] || 0);
                }

                 if(i == dayList.length-1){
                    row[dayList[i]] = k/t;
                 }
                 else{
                    k += t1;
                    t += t2;
                }
             }
            data.rows.push(row);  
        }
        for(var center in dataMap5) {
             var row = {};
             var k = 0;
             var t = 0;
             var t1;
             var t2;
             row.name = center;          
             for(var i = 0; i < dayList.length; i++) {
                if(dataMap5[center][dayList[i]] == null){
                    row[dayList[i]] = '';
                    t1 = 0;
                    t2 = 0;
                }
                else{
                    row[dayList[i]] = dataMap5[center][dayList[i]]/dataMap6[center][dayList[i]] || 0;
                    t1 = (dataMap5[center][dayList[i]] || 0);
                    t2 = (dataMap6[center][dayList[i]] || 0);
                }

                 if(i == dayList.length-1){
                    row[dayList[i]] = k/t;
                 }
                 else{
                    k += t1;
                    t += t2;
                }
             }
             if (center != total) {data.rows.push(row);} else{data.footer.push(row);};  
        }

        var p = [];
        for(var center in dataMap) {
            if(dataMap[center].parents != undefined){
                p[center] = dataMap[center].parents;
            }
        }
        for(var center in dataMap3) {
            if(dataMap3[center].parents != undefined){
                p[center] = dataMap3[center].parents;
            }
        }

        var rank1 = [];
        var rank2 = [];
        var rank3 = [];
        var no = 1;
        for(i = 0; i < data.rows.length; i++){
            if(data.rows[i].name.indexOf('→') < 0){
                data.rows[i].id = no;
                no++;
                rank1.push(data.rows[i]);
                data.rows[i].state = "closed";

                for(j = 0; j < data.rows.length; j++){
                    var temp = p[data.rows[j].name];
                    if(temp == data.rows[i].name){
                        data.rows[j].id = no;
                        data.rows[j]._parentId = data.rows[i].id;
                        no++;
                        rank2.push(data.rows[j]);
                        data.rows[j].state = "closed";

                        for(k = 0; k < data.rows.length; k++){
                            var temp2 = p[data.rows[k].name];
                            if(temp2 == data.rows[j].name){
                                data.rows[k].id = no;
                                data.rows[k]._parentId = data.rows[j].id;
                                no++;
                                rank3.push(data.rows[k]);
                            }
                        }
                    }
                }
            }
        }

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }
       

            // var globalValiable = window.parent.globalValiable;
            // if(globalValiable && globalValiable.data) {
            //     queryParams = globalValiable.queryParams;
            //     show(globalValiable.data);
            //     return;
            // }
         

        function styler(value,row,index){
            if(value>=10){
                return 'color:#C70B25;font-weight:bold;';
            }
            else if(value<6){
                return 'color:#389562;font-weight:bold;';
            }
            else{
                return 'color:#F28705;font-weight:bold;';
            }
        }

        function formatter(value, row, index){
            if(value == ''){
                return value;
            }
            else{
                return formatMoney(value, 1);
            }
        }

        function formatMoney(s, n) {   
           n = n > 0 && n <= 20 ? n : 2;   
           s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
           var l = s.split(".")[0].split("").reverse(),   
           r = s.split(".")[1];   
           t = "";   
           for(i = 0; i < l.length; i ++ ) {   
              t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
           }   
           return t.split("").reverse().join("") + "." + r;   
        } 
    
    </script>
</head>

<body>
    <div class="easyui-accordion" data-options="fit:true">
        <div title="明细">
            <table id="detailTable" >
                <thead frozen="true">
                    <tr>
                        <th field="name" width="200">名称</th>
                    </tr>
                </thead>
                <thead>
                    <tr id="cityColumn"></tr>
                </thead>
            </table>
        </div>
        <div title="图表" style="padding: 10px">
            <div id='container'></div>
        </div>
    </div>
</body>
</html>