<!DOCTYPE HTML>
<HTML xmlns:WorkSpace xmlns:Tree xmlns:Grid>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>    
<meta charset="UTF-8">
<title>数据录入</title>

<link href="../../css/css.css" rel="stylesheet">
<link href="../../tools/tssJS/css/tss.all.css" rel="stylesheet">
<link href="../../tools/tssJS/css/tss.button.css" rel="stylesheet">

<script src="../../tools/tssJS/tssJS.all.js"></script>
<script src="../../tools/tssJS/tssJS.json2Form.js"></script>
<script src="../../tools/tssUtils.js"></script>

<style type="text/css">
    body { overflow-x:auto; }

    #ws {
        width: 40%;
        max-width: 600px;
        min-width: 400px;
        height: 100%;
        position: fixed;
        right: 0;
        top: 1px;
    }

    #page1Form {
        height: 85%;
        overflow: auto; 
    }

    .Formbox { display:none; background-color:#BEC6EE; border:1px solid #416371; border-radius: 5px; }
    #searchFormDiv { display: none; width:500px; height:400px; padding: 10px; overflow: auto; }
    #searchFormDiv .buttonBox { margin: 20px 10px 10px 55px;  }
    #searchFormDiv h3 { font-size: 120%; margin-bottom: 10px; }

</style>

<SCRIPT type="text/javascript">
<!-- 

/* 后台响应数据节点名称 */
XML_SOURCE_LIST = "RecordData";

/* XMLHTTP请求地址汇总 */
URL_SOURCE_LIST   = AUTH_PATH + "xdata/xml/";
URL_SAVE_SOURCE   = AUTH_PATH + "xdata/";
URL_DELETE_SOURCE = AUTH_PATH + "xdata/";
URL_GET_DEFINES   = AUTH_PATH + "xdata/define/";
URL_GET_USER_HAS  = AUTH_PATH + "user/has";

var recordId = 1, recordName = "数据录入", recordDefine, customizeJS, userGroups = [], userRoles = [];

$(function() {
    var globalValiable = window.parent.globalValiable;
    if(globalValiable) {
        recordId   = globalValiable.id;
        recordName = globalValiable.name;

        init();
        return;
    }

    // just Test
    URL_SOURCE_LIST   = "data/data_grid.xml?";
    URL_SAVE_SOURCE   = "data/_success.xml?";
    URL_DELETE_SOURCE = "data/_success.xml?";
    URL_GET_DEFINES   = "data/record_define.json?";
    URL_GET_USER_HAS  = "data/user_has.json?";

    init();
});

/* 页面初始化 */
function init() {
    initMenus();
    initWorkSpace();

    $.ajax({
        url : URL_GET_DEFINES + recordId,
        type : "json",
        ondata: function() {
            var result = this.getResponseJSON();
            recordDefine = result[0];
            customizeJS = result[1];
        }
    });

    $.ajax({
        url : URL_GET_USER_HAS,
        method : "GET",
        type : "json",
        ondata: function() {
            var result = this.getResponseJSON();
            userGroups = result[0];
            userRoles = result[1];
        }
    });

    loadGridData({}, 1); 
    $("#rcTitle").html("【" + recordName + "】");
}

function initMenus() {
    /* Grid菜单初始化  */
    var item1 = {
        label:"编辑",
        callback: showDetail,
        icon: "images/icon_edit.gif"
    }
    var item2 = {
        label:"删除",
        callback: remove,
        icon: "images/icon_del.gif"
    }

    var menu = new $.Menu();
    menu.addItem(item1);
    menu.addItem(item2);
    $1("grid").contextmenu = menu;
}

/* grid加载数据  */
function loadGridData(params, page) {
    $.showGrid(URL_SOURCE_LIST + recordId, XML_SOURCE_LIST, showDetail, "grid", page, params);
}

/* 显示资源详细信息 */
function showDetail(isCreate) {    
    var rowID = isCreate ? '_new' : $.G("grid").getColumnValue("id");  
    var rowName = recordName + rowID;

    var callback = {};
    callback.onTabClose = function(eventObj){
        if( ws.noTabOpend() ) {
            $("#ws").hide();
        }            
    };

    callback.onTabChange = function() {
        setTimeout(function() {
            loadDetailData(rowID);

        }, TIMEOUT_TAB_CHANGE);
    };

    var inf = {};
    inf.label = rowName;
    inf.SID = "viewRow_" + rowID;
    inf.defaultPage = "page1";
    inf.callback = callback;
    var tab = ws.open(inf);   

    $("#ws").show(true);    
}

function loadDetailData(rowID) {
    if(rowID != '_new') {
        var grid = $.G("grid");
        recordDefine.each(function(i, field){
            field.defaultValue = grid.getColumnValue(field.code);
        });
    }

    var xform = $.json2Form("page1Form", recordDefine, null, customizeJS);

    $.cache.XmlDatas[rowID] = xform.template.dataNode;

    attachReminder(rowID, xform); // 离开提醒

    // 设置保存/关闭按钮操作
    $1("page1BtCancel").onclick = function() {
        ws.closeActiveTab();
    }
    $1("page1BtSave").onclick = function() {
        saveSource(rowID);
    }
}

function saveSource(rowID) {
    var xform = $.F("page1Form");  
    if( !xform.checkForm() ) return;

    var request = new $.HttpRequest();
    request.url = URL_SAVE_SOURCE + recordId;

    var dataNode = $.cache.XmlDatas[rowID];
    request.setFormContent(dataNode);

    if(rowID != '_new') {
       request.url += "/" + rowID;
    }

    syncButton([$1("page1BtSave")], request); // 同步按钮状态
    detachReminder(rowID); // 解除提醒

    request.onsuccess = function() { // 更新
        loadGridData({}, $1("GridPageList").value || 1); 
        ws.closeActiveTab();
    }
    request.send();
}

function remove()  { 
    $.confirm("您确定要删除该行记录吗？", "删除确认", function(){
        var grid = $.G("grid");
        var rowID  = grid.getColumnValue("id");
        if( rowID ) {
            $.ajax({
                url : URL_DELETE_SOURCE + recordId + "/" + rowID,
                method : "DELETE",
                onsuccess : function() { 
                    grid.deleteSelectedRow();
                }
            }); 
        }
    });
}

function showQueryForm() {
    if($.cache.XmlDatas["searchFormXML"]) {
        $("#searchFormDiv").show(true).center(1000, 400);
        return;
    }

    var buttonBox = [];
    buttonBox[buttonBox.length] = "        <TR>";
    buttonBox[buttonBox.length] = "          <TD colspan='2' height='46'><div class='buttonBox'>";
    buttonBox[buttonBox.length] = "             <input type='button' class='btStrong' id='btSearch' value='查询'/> - ";
    buttonBox[buttonBox.length] = "             <input type='button' class='btWeak' id='btCloseSearch' value='关闭'/>";
    buttonBox[buttonBox.length] = "          </div></TD>";
    buttonBox[buttonBox.length] = "        </TR>";

    var paramsConfig = [];
    recordDefine.each(function(i, field){
        if(field.isparam === 'true') {
            var copy = {};
            for (var name in field) {
                copy[name] = field[name];
            }
            delete copy["nullable"];
            delete copy["height"];
            delete copy["width"];
            delete copy["defaultValue"];
            delete copy["onchange"];
            delete copy["multiple"];
            copy.name = "p_" + (copy.name || copy.code);
            paramsConfig.push(copy);
        }
    });
    paramsConfig.push({"label": "创建人", "name": "p_creator"});
    paramsConfig.push({"label": "修改人", "name": "p_updator"});

    var searchForm = $.json2Form("searchForm", paramsConfig, buttonBox.join(""));

    $("#searchFormDiv").show(true).center(1000, 400);
    $("#searchFormDiv h3").html("查询【" + recordName + "】的录入数据");

    $.cache.XmlDatas["searchFormXML"] = searchForm.template.sourceXML;
    
    $1("btSearch").onclick = function () {
        if( searchForm.checkForm() ) {
            $("#searchFormDiv").hide();
            var searchFormXML = $.cache.XmlDatas["searchFormXML"];
            var dataNode = searchFormXML.querySelector("data");
        
            var params = {};
            var nodes = dataNode.querySelectorAll("row *");
            for(var i = 0; i < nodes.length; i++) {
                var node = nodes[i];
                params[node.nodeName.substring(2)] = $.XML.getText(node);
            }
            loadGridData(params, 1);
        }
    }
    $1("btCloseSearch").onclick = function () {
        $("#searchFormDiv").hide();
    }
}

// ------------------------------------------------- 自定义扩展 ------------------------------------------------
/*
 *  多级下拉选择联动
 *  参数： nextL    下一级联动参数的序号
        serviceID       下一级联动的service地址             
        currParam       当前联动参数的序号
        currParamValue  当前联动参数的值
 */
function getNextLevelOption(nextL, serviceID, currParam, currParamValue) {
    if(nextL == null || serviceID == null || currParam == null || $.isNullOrEmpty(currParamValue)) return;

    var dreg = /^[1-9]+[0-9]*]*$/;

    // serviceID maybe is ID of record, maybe a serviceUrl
    var url = dreg.test(serviceID) ? '../../data/json/' + serviceID : serviceID;
    
    var xform = $.F("page1Form");
    $.getNextLevelOption(xform, currParam, currParamValue, url, nextL);
}

/* nextLevel("season", "month", 
 *   {"春":"三月|四月|五月", "夏":"六月|七月|八月", "秋":"九月|十月|十一月", "冬":"十二月|一月|二月"});
 */
function nextLevel(current, next, map) {
    var currentVal = $("#" + current).value();
    var nextOpts = map[currentVal];
    if(!nextOpts) {
        return;
    }

    var xform = $.F("page1Form");
    xform.updateField(next, [
        {"name": "texts", "value": nextOpts},
        {"name": "values", "value": nextOpts}
     ]);
}

// 依据用户的角色和组织判断用户是否能对指定字段可编辑
function forbid(field, role, group) {
    var xform = $.F("page1Form");
    var editable = false;
    if(role) {
        editable = userRoles.contains(role);
    } 
    if(group) {
        if(userGroups && userGroups.length) {
            var g = userGroups[userGroups.length - 1];
            if(group == g[0] || group == g[1]) {
                editable = true;
            }
        }
    }  

    if(!editable) {
        xform.setFieldEditable(field, "false"); 
    }
}

function calculateSum(totalField, fields) {
    var xform = $.F("page1Form");
    forbid(totalField); 
    fields.each(function(i, field){
        $("#" + field).blur(function(){
            var value = 0;
            fields.each(function(j, f){
                value += getFloatValue(f);
            });
            xform.updateDataExternal(totalField, value);    
            xform.updateData(this);
        });
    });
}

function getFloatValue(field) {
    return parseFloat($("#" + field).value() || '0');
}

// onlyOne(["udf1", "udf2", "udf3"]);
function onlyOne( fields ) {
    var xform = $.F("page1Form");
    fields.each(function(i, field){
        $("#" + field).blur(function(){
            var value = this.value;
            
            fields.each(function(j, f){
                if(field !== f) {
                    xform.setFieldEditable(f, !value ? "true" : "false");   
                }
            });

            xform.updateData(this);
        });
    });
}

//-->
</SCRIPT>

</head>

<body>

    <table>
        <tr>
          <td id="gridTitle">
            <span class="icon"></span><span id="rcTitle">资源列表</span>&nbsp;
            <input type="button" class="btStrong" value="新 增" onclick="showDetail(true)"/>&nbsp;
            <input type="button" class="btStrong" value="查 询" onclick="showQueryForm()"/>
            <span class="buttonBox" id="gridToolBar"></span>
          </td>
        </tr>
        <tr>
          <td class="gridContainer"><Grid id="grid"></Grid></td>
        </tr>
    </table>

    <WorkSpace:Box id="ws" class="hiddenWS">
        <WorkSpace:Page id="page1">
            <div id="page1Form" editable="true"></div>
            <WorkSpace:PageStep>
                <br>
                <input type="button" class="btStrong" value="完成" id="page1BtSave"/>&nbsp;
                <input type="button" class="btWeak" value="取消" id="page1BtCancel"/>
            </WorkSpace:PageStep>
        </WorkSpace:Page>
    </WorkSpace:Box>

    <div id="searchFormDiv" class="Formbox">
        <h3></h3>
        <div id="searchForm"></div>
    </div>

</body>
</html>