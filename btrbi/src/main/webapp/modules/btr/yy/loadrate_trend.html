<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>装载率</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>

    <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable,
        Type = '',dataA,
        Len,
        p = [],
        st;

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
        var con = document.getElementById('container'),
            tab = document.getElementById('detailTable');
        
        con.style.height = (screen.height * 0.9091 - 178) + 'px';
        tab.style.height = (screen.height - 240) + 'px';

        var v = 1;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            sub = queryParams.param1 + '至' + queryParams.param2;
            if(queryParams.param3 == undefined){
                show(globalValiable.data,queryParams.param1,'全网');
                document.getElementById("center")
                    .options.add(new Option('全网','全网'));
                document.getElementById("center2")
                    .options.add(new Option('全网','全网'));
                Type = '全网';
            }
            else{
                show(globalValiable.data,queryParams.param1,'总计');
                if(queryParams.param3.indexOf('分拨') >= 0){
                    v = 0;
                }
            }

            var originData = globalValiable.data;
            var companylist = [];
            var centerlist = [];
            for(var i = 0; i < originData.length; i++) {    
                if(v){    
                    var company = originData[i]["fgs"];
                    if( !companylist.contains(company) ){
                        companylist.push(company);
                        document.getElementById("center")
                        .options.add(new Option(company,company));
                        document.getElementById("center2")
                        .options.add(new Option(company,company));
                    }
                }
                
                var center = originData[i]["fb"];
                if((!centerlist.contains(center))&&(center.indexOf('→') < 0)){
                    centerlist.push(center);
                    document.getElementById("center")
                     .options.add(new Option(center,center));
                    document.getElementById("center2")
                     .options.add(new Option(center,center));
                }
            }

            painting();
            return;
        }
    } 

    function painting(){
        var center = document.getElementById('center').value;
        queryParams = globalValiable.queryParams;
        sub = queryParams.param1 + '至' + queryParams.param2;
        if(Type == '全网'){
            if(center == '全网'){
                showTu(globalValiable.data,queryParams.param1,sub,'全网');
            }
            else{
                showTu(globalValiable.data,queryParams.param1,sub,center);
            }
        }
        else{
            showTu(globalValiable.data,queryParams.param1,sub,center);
        }
    }

        function showTu(originData,startday,subtit,tit) {
        var center = document.getElementById('center').value;
        var sd = 0;
        var data = [];
        var dataday = [];
        var maxr = 0;
        var minr = 100;
        var n = [];
        var tn = [];
        var dayList = [];

        for(var i = 0; i < originData.length; i++) {
        var day = originData[i]["inday"],
            fgs = originData[i]["fgs"],
            fb = originData[i]["fb"];

            if( !dayList.contains(day) ){
                dayList.push(day);
            }

            if(n[day] == null){
                n[day] = 0;
                tn[day] = 0;
            }

            if(center == '全网'){
                n[day] += originData[i]["w"];
                tn[day] += originData[i]["lw"];
            }
            else if((center.indexOf('公司') >= 0)&&(fgs == center)){
                n[day] += originData[i]["w"];
                tn[day] += originData[i]["lw"];
            }
            else if((center.indexOf('分拨') >= 0)&&(fb == center)){
                n[day] += originData[i]["w"];
                tn[day] += originData[i]["lw"];
            }       
        }

        for(var i = 0; i < dayList.length; i++) {
            if(dayList[i]  == startday){
                sd = i;
                break;
            }
        }

        var j = 0;
        for(var i = sd-28; i < dayList.length; i++) {
            data[j] = Math.round(n[dayList[i]]/tn[dayList[i]]*1000)/10;
            dataday[j] = dayList[i];    

            if(data[j]>maxr){
                maxr = data[j];
            }

            if(data[j]<minr){
                minr = data[j];
            }

            j += 1;
        }

        maxr = Math.ceil(maxr/5)*5+5;
        minr = Math.floor(minr/5)*5-5;
        if(minr<0){
            minr = 0;
        }

        var myChart = echarts.init(document.getElementById('container'));
 
        var option = {
    backgroundColor:'#fff',
    title : {
        text: tit+'装载率走势',
        textStyle:{fontSize:'24',color:'#000',fontFamily:'Microsoft YaHei'},
        subtext:subtit,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    tooltip : {
        trigger: 'axis',
        textStyle:{fontSize:'16',color:'#fff',fontFamily:'Microsoft YaHei'},
        axisPointer:{type : 'shadow',shadowStyle : {size: 'auto',color: 'rgba(255,127,36,0.3)'}}
    },
    calculable : true,
    dataZoom : {
        show : true,
        realtime : true,
        start : 80,
        end : 100,
        dataBackgroundColor:'#FFF',
        fillerColor:'#008972',
        handleColor:'#008972'
    },
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#999999'}},
            boundaryGap : false,
            axisLabel:{
                interval:0,
                textStyle:{color:'#999999',fontSize:'14'}
            },
            data : dataday
        }
    ],
    yAxis : [
        {
            name:'百分比',
            nameTextStyle:{
                fontSize:'16',
                fontFamily:'Microsoft YaHei'
            },
            type : 'value',
            axisLine:{lineStyle:{color:'#999999'}},
            axisLabel:{textStyle:{color:'#999999',fontSize:'14'}},
            min:minr,
            max:maxr
        }
    ],
    series : [
        {
            name:'装载率',
            type:'line',
            data:data,
            color:'#008972',
            itemStyle: {                // 系列级个性化
                normal: {
                    borderWidth: 1,
                    borderColor:'#008972',
                    color: '#008972'
                },
                emphasis: {
                    borderColor:'#008972',
                    color: '#008972'
                }
            },
            markPoint : {
                data : [
                    {type : 'max', name: '最大值'},
                    {type : 'min', name: '最小值'}
                ],
                itemStyle:{
                    normal : {
                        color:'#008972'
                    }
                }
            }
        }
    ]
};            
        myChart.setOption(option);
    }

    function show(originData,startday,total) { 
        var centers = [];        
        var dayList = [];  
        var dataMap = {};  
        var dataMap2 = {};   
        var dataMap3 = {};  
        var dataMap4 = {};
        var dataMap5 = {};  
        var dataMap6 = {};  

        for(var i = originData.length - 1; i >= 0 ; i--){
            if(originData[i]["inday"] == startday){
                st = i;
                break;
            }
        }

        for(var i = st - 1; i >= 0 ; i--){
            if(originData[i]["inday"] != startday){
                st = i;
                break;
            }
        }

        for(var i = st + 1; i < originData.length; i++) {
            var day = originData[i]["inday"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }

            var r = originData[i]["routine"];
            if(dataMap[r] == null) {
                 dataMap[r] = [];                 
            }
            if(dataMap2[r] == null) {
                 dataMap2[r] = [];                 
            }
            dataMap[r][day] = originData[i]["w"];
            dataMap2[r][day] = originData[i]["lw"];

            var center = originData[i]["fb"];
            dataMap[r].parents = center;

            if(dataMap3[center] == null) {
                 dataMap3[center] = [];                 
            }
            if(dataMap4[center] == null) {
                 dataMap4[center] = [];                 
            }

            if(dataMap3[center][day] == null){
                dataMap3[center][day] = originData[i]["w"];
                dataMap4[center][day] = originData[i]["lw"];
            }
            else{
                dataMap3[center][day] += originData[i]["w"];
                dataMap4[center][day] += originData[i]["lw"];
            }

            var company = originData[i]["fgs"];
            dataMap3[center].parents = company;

            if(dataMap5[company] == null) {
                 dataMap5[company] = [];                 
            }
            if(dataMap6[company] == null) {
                 dataMap6[company] = [];                 
            }

            if(dataMap5[company][day] == null){
                dataMap5[company][day] = originData[i]["w"];
                dataMap6[company][day] = originData[i]["lw"];
            }
            else{
                dataMap5[company][day] += originData[i]["w"];
                dataMap6[company][day] += originData[i]["lw"];
            }

            if(dataMap5[total] == null) {
                 dataMap5[total] = [];                 
            }
            if(dataMap6[total] == null) {
                 dataMap6[total] = [];                 
            }

            if(dataMap5[total][day] == null){
                dataMap5[total][day] = originData[i]["w"];
                dataMap6[total][day] = originData[i]["lw"];
            }
            else{
                dataMap5[total][day] += originData[i]["w"];
                dataMap6[total][day] += originData[i]["lw"];
            }
        }

        for(var center in dataMap){
            for(var i=0;i<dayList.length;i++){
                if(dataMap[center][dayList[i]] == undefined){
                    dataMap[center][dayList[i]] = null;
                }
            }
        }

        for(var center in dataMap3){
            for(var i=0;i<dayList.length;i++){
                if(dataMap3[center][dayList[i]] == undefined){
                    dataMap3[center][dayList[i]] = null;
                }
            }
        }

        for(var center in dataMap5){
            for(var i=0;i<dayList.length;i++){
                if(dataMap5[center][dayList[i]] == undefined){
                    dataMap5[center][dayList[i]] = null;
                }
            }
        }

        dayList[dayList.length] = '累计';
        var cHtml = [];       
        for(var i=0; i < dayList.length; i++) {         
            if (i<dayList.length-1){
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
            }
            else{
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">累计</th>');
            }
        }
        
        $$("cityColumn").innerHTML = cHtml.join("\n");

        
        var data = {};
        data.rows = [];
        data.footer = [];
        for(var center in dataMap) {
             var row = {};
             var k = 0;
             var t = 0;
             var t1;
             var t2;
             row.name = center;     
             for(var i = 0; i < dayList.length; i++) {
                if(dataMap[center][dayList[i]] == null){
                    row[dayList[i]] = '';
                    t1 = 0;
                    t2 = 0;
                }
                else{
                    row[dayList[i]] = dataMap[center][dayList[i]]/dataMap2[center][dayList[i]] || 0;
                    t1 = (dataMap[center][dayList[i]] || 0);
                    t2 = (dataMap2[center][dayList[i]] || 0);
                }
                 
                if(i == dayList.length-1){
                    row[dayList[i]] = k/t;
                }
                else{
                    k = k + t1;
                    t = t + t2;
                }
             }
             data.rows.push(row);      
        }

        for(var center in dataMap3) {
             var row = {};
             var k = 0;
             var t = 0;
             var t1;
             var t2;
             row.name = center;          
             for(var i = 0; i < dayList.length; i++) {
                if(dataMap3[center][dayList[i]] == null){
                    row[dayList[i]] = '';
                    t1 = 0;
                    t2 = 0;
                }
                else{
                    row[dayList[i]] = dataMap3[center][dayList[i]]/dataMap4[center][dayList[i]] || 0;
                    t1 = (dataMap3[center][dayList[i]] || 0);
                    t2 = (dataMap4[center][dayList[i]] || 0);
                }

                 if(i == dayList.length-1){
                    row[dayList[i]] = k/t;
                 }
                 else{
                    k += t1;
                    t += t2;
                }
             }
            data.rows.push(row);  
        }
        for(var center in dataMap5) {
             var row = {};
             var k = 0;
             var t = 0;
             var t1;
             var t2;
             row.name = center;          
             for(var i = 0; i < dayList.length; i++) {
                if(dataMap5[center][dayList[i]] == null){
                    row[dayList[i]] = '';
                    t1 = 0;
                    t2 = 0;
                }
                else{
                    row[dayList[i]] = dataMap5[center][dayList[i]]/dataMap6[center][dayList[i]] || 0;
                    t1 = (dataMap5[center][dayList[i]] || 0);
                    t2 = (dataMap6[center][dayList[i]] || 0);
                }

                 if(i == dayList.length-1){
                    row[dayList[i]] = k/t;
                 }
                 else{
                    k += t1;
                    t += t2;
                }
             }
             if (center != total) {data.rows.push(row);} else{data.footer.push(row);};  
        }

        for(var center in dataMap) {
            if(dataMap[center].parents != undefined){
                p[center] = dataMap[center].parents;
            }
        }
        for(var center in dataMap3) {
            if(dataMap3[center].parents != undefined){
                p[center] = dataMap3[center].parents;
            }
        }

        var rank1 = [];
        var rank2 = [];
        var rank3 = [];
        var no = 1;
        for(i = 0; i < data.rows.length; i++){
            if(data.rows[i].name.indexOf('公司') >= 0){
                data.rows[i].id = no;
                no++;
                rank1.push(data.rows[i]);
                data.rows[i].state = "closed";

                for(j = 0; j < data.rows.length; j++){
                    var temp = p[data.rows[j].name];
                    if(temp == data.rows[i].name){
                        data.rows[j].id = no;
                        data.rows[j]._parentId = data.rows[i].id;
                        no++;
                        rank2.push(data.rows[j]);
                        data.rows[j].state = "closed";

                        for(k = 0; k < data.rows.length; k++){
                            var temp2 = p[data.rows[k].name];
                            if(temp2 == data.rows[j].name){
                                data.rows[k].id = no;
                                data.rows[k]._parentId = data.rows[j].id;
                                no++;
                                rank3.push(data.rows[k]);
                            }
                        }
                    }
                }
            }
        }

        dataA = data;
        Len = data.rows.length;

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }
       

            // var globalValiable = window.parent.globalValiable;
            // if(globalValiable && globalValiable.data) {
            //     queryParams = globalValiable.queryParams;
            //     show(globalValiable.data);
            //     return;
            // }
         

        function styler(value,row,index){
            if(value>=0.7){
                return 'color:#389562;font-weight:bold;';
            }
            else if(value<0.4){
                return 'color:#C70B25;font-weight:bold;';
            }
            else{
                return 'color:#F28705;font-weight:bold;';
            }
        }

        function formatter(value, row, index){
            if(value == ''){
                return value;
            }
            else{
                return formatMoney(value*100, 1)+'%';
            }
        }

        function formatMoney(s, n) {   
           n = n > 0 && n <= 20 ? n : 2;   
           s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
           var l = s.split(".")[0].split("").reverse(),   
           r = s.split(".")[1];   
           t = "";   
           for(i = 0; i < l.length; i ++ ) {   
              t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
           }   
           return t.split("").reverse().join("") + "." + r;   
        } 



    function reset(){
        if(Len){
            for(var i=Len;i>0;i--){
                $('#detailTable').treegrid('remove',i);
            }
        }
        
        var rank1 = [];
        var rank2 = [];
        var rank3 = [];
        var no = 1;
        for(i = 0; i < dataA.rows.length; i++){
            if(dataA.rows[i].name.indexOf('公司') >= 0){
                dataA.rows[i].id = no;
                no++;
                rank1.push(dataA.rows[i]);
                dataA.rows[i].state = "closed";

                for(j = 0; j < dataA.rows.length; j++){
                    var temp = p[dataA.rows[j].name];
                    if(temp == dataA.rows[i].name){
                        dataA.rows[j].id = no;
                        dataA.rows[j]._parentId = dataA.rows[i].id;
                        no++;
                        rank2.push(dataA.rows[j]);
                        dataA.rows[j].state = "closed";

                        for(k = 0; k < dataA.rows.length; k++){
                            var temp2 = p[dataA.rows[k].name];
                            if(temp2 == dataA.rows[j].name){
                                dataA.rows[k].id = no;
                                dataA.rows[k]._parentId = dataA.rows[j].id;
                                no++;
                                rank3.push(dataA.rows[k]);
                            }
                        }
                    }
                }
            }
        }

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: dataA
        });

        Len = dataA.rows.length;
    }

    function select(){
        var originData = globalValiable.data,
            center = document.getElementById('center2').value,
            max = document.getElementById('maxs').value,
            min = document.getElementById('mins').value,
            data = [],
            no = 1,
            centerList = [];

        for(var i = st + 1; i < originData.length; i++) {
            if(center.indexOf('分拨') >= 0){
                var rou = originData[i]["routine"],
                    cen = originData[i]["fb"];
                if((!centerList.contains(rou))&&(center.indexOf(cen)>=0)){
                    centerList.push(rou);
                }
            }
            else{
                var rou = originData[i]["routine"],
                    cen = originData[i]["fb"],
                    com = originData[i]["fgs"];
                if((!centerList.contains(rou))&&(center.indexOf(com)>=0)){
                    centerList.push(rou);
                }
                if((!centerList.contains(cen))&&(center.indexOf(com)>=0)){
                    centerList.push(cen);
                }
            }
        }

        if(Len){
            for(var i=Len;i>0;i--){
                $('#detailTable').treegrid('remove',i);
            }
        }

        for(var i=0;i<dataA.rows.length;i++){
            if((dataA.rows[i].累计*100>=min)&&(dataA.rows[i].累计*100<=max)){
                if((center == '全网')||(centerList.contains(dataA.rows[i].name))||
                    (dataA.rows[i].name == center)){
                    var temp = dataA.rows[i];
                    temp.id = no;
                    temp.state = 'open';
                    data.push(temp);
                    no++
                }              
            }  
        }

        Len = data.length;

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }
    
    </script>

    <style type="text/css">
        dt {font-family:Microsoft YaHei;font-size:20px;}
        dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
    </style>
</head>

<body>
    <div class="easyui-tabs" data-options='fit:true'>
        <div title="走势图" style="font-family:Microsoft YaHei;font-size:16px;">
            选择: <select id="center" style="font-family:Microsoft YaHei;font-size:16px;" onchange="painting()">     
            </select>&nbsp;
            <button id='repainting' onClick='painting()' style="width:60px;font-family:Microsoft YaHei;font-size:16px;">刷新</button>
            <div style='float:right;'>
                <input class="easyui-searchbox" data-options="prompt:'请输入查询分拨名称',searcher:doSearch" style="font-family:Microsoft YaHei;font-size:16px;"></input>
                <script>
                    function doSearch(value){
                        var inform = document.getElementById("center"),
                            selected = [];

                        for(var i=0;i <inform.options.length;i++){
                            if((inform.options[i].value.indexOf(value) >= 0)&&
                                (value.length > 0)){
                               selected.push(inform.options[i].value);
                            }
                        }

                        if(selected[1] != undefined){
                            var company,
                                center,
                                len = 100;
                            for(var i=0;i <selected.length;i++){
                                if(selected[i].indexOf('分公司') >= 0){
                                    company = i;
                                }
                                else{
                                    if((selected[i].length - value.length) < len){
                                        len = selected[i].length;
                                        center = i;
                                    }
                                }
                            }

                            if(confirm('是否查询' + selected[company] + '?')){
                                inform.value = selected[company];
                            }
                            else{
                                inform.value = selected[center];
                            }
                            painting();
                        }
                        else if(selected[0] != undefined){
                            inform.value = selected[0];
                            painting();
                        }
                    }
                </script>
            </div>
            <div id='container' style="height:640px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="细节表">
            <div style="font-family:Microsoft YaHei;font-size:16px;">
                选择: <select id="center2" style="font-family:Microsoft YaHei;font-size:16px;" onchange="painting()">   
                </select>&nbsp;
                大于：<input class="easyui-numberbox" id='mins' value='0' style="width:25px;font-family:Microsoft YaHei;font-size:16px;text-align:right;"></input>%
                小于：<input class="easyui-numberbox" id='maxs' value='40' style="width:25px;font-family:Microsoft YaHei;font-size:16px;text-align:right;"></input>%
                <button id='select' onClick='select()' style="width:60px;font-family:Microsoft YaHei;font-size:16px;">筛选</button>
                <button id='reset' onClick='reset()' style="width:60px;font-family:Microsoft YaHei;font-size:16px;">重置</button>
            </div>
            <table id="detailTable">
                <thead frozen="true">
                    <tr>
                        <th field="name" width="200">名称</th>
                    </tr>
                </thead>
                <thead>
                    <tr id="cityColumn"></tr>
                </thead>
            </table>
        </div>  
        <div title="说明书">
            <dl>
            <dt>取值逻辑</dt>
            <dd>- 根据当天的网络班车信息计算线路总额重，匹配数据库中各方向发件扫描货量</dd>
            <dt>时间节点</dt>
            <dd>- 当日12:00AM至次日12:00AM</dd>
            <dt>注意点</dt>
            <dd>- 装载率最小单元按照线路计算，并不精确到车</dd>
            <dd>- 经停车例如A→B→C，拆分为A→B、A→C计算</dd>
            <dd>- 装载重量取值为实际装载重量</dd>
            <dd>- 细节表中的装载率，以出发分公司、出发分拨以及线路归集</dd>
            <dd>- 平均时效达成率，参见《省份装载率地图》、《分拨装载率地图》</dd>
            </dl>
        </div>
    </div>
</body>
</html>