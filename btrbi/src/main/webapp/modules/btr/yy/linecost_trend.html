<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>车线成本走势</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable,
        Type = '',
        dataA,
        Len,
        p = [],
        st;

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
        var con = document.getElementById('container'),
            tab = document.getElementById('detailTable');
        
        con.style.height = (screen.height * 0.9091 - 178) + 'px';
        tab.style.height = (screen.height - 240) + 'px';


        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            if(queryParams.param3 == undefined){
                show(globalValiable.data,'全网',queryParams.param1);
                Type = '全网';
            }
            else{
                show(globalValiable.data,'总计',queryParams.param1);
            }

            var originData = globalValiable.data;
            var companylist = [];
            var centerlist = [];
            for(var i = 0; i < originData.length; i++) {        
                var company = originData[i]["company"];
                if( !companylist.contains(company) ){
                    companylist.push(company);
                    document.getElementById("center")
                    .options.add(new Option(company,company));
                    document.getElementById("center2")
                    .options.add(new Option(company,company));
                }
   
                var center = originData[i]["center"];
                if( !centerlist.contains(center) ){
                    centerlist.push(center);
                    document.getElementById("center")
                    .options.add(new Option(center,center));
                }
            }

            painting()
            return;
        }
    } 

    function painting(){
        var center = document.getElementById('center').value;
        queryParams = globalValiable.queryParams;
        sub = queryParams.param1 + '至' + queryParams.param2;
        if(Type == '全网'){
            showTu(globalValiable.data,sub,center);
        }
        else{
            showTu(globalValiable.data,sub,center);
        }
    }

    function showTu(originData,subtit) {
        var center = document.getElementById('center').value,
            data = [],
            dayList = [],
            n = [],
            max = 0;

        for(var i = 0; i < originData.length; i++) {
            var day = originData[i]["inday"],
                fb = originData[i]["center"],
                fgs = originData[i]["company"];
            
            if( !dayList.contains(day) ){
                dayList.push(day);
                n[day] = 0;
            }

            if(center == '全网'){
                n[day] += originData[i]["fee"];
            }
            else if((center.indexOf('公司') >= 0)&&(fgs == center)){
                n[day] += originData[i]["fee"];
            }
            else if((center.indexOf('分拨') >= 0)&&(fb == center)){
                n[day] += originData[i]["fee"];
            }
        }

        for(var i = 0; i < dayList.length; i++){
            data[i] = Math.round(n[dayList[i]],1);

            if(data[i]>max){
                max = data[i];
            }
        }

        var sca;
        if(max>=200000){
            sca = 100000;
        }
        else if((max<200000)&&(max>=20000)){
            sca = 10000;
        }
        else if((max<20000)&&(max>=2000)){
            sca = 1000;
        }
        else if((max<2000)&&(max>=200)){
            sca = 100;
        }
        else{
            sca = 10;
        }

        max = Math.ceil(max/sca)*sca;

    var myChart = echarts.init(document.getElementById('container'));

var option = {
    backgroundColor:'#ffffff',
    title : {
        text: center + '车线成本走势图',
        textStyle:{fontSize:'24',color:'#000',fontFamily:'Microsoft YaHei'},
        subtext:subtit,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    tooltip : {
        trigger: 'axis',
        textStyle:{fontSize:'16',color:'#fff',fontFamily:'Microsoft YaHei'}
    },
    calculable : true,
    dataZoom : {
        show : true,
        realtime : true,
        start : 80,
        end : 100,
        dataBackgroundColor:'#fff',
        fillerColor:'#008080',
        handleColor:'#008080'
    },
    xAxis : [
        {
            type : 'category',
            axisLine:{show:false},
            boundaryGap : false,
            axisLabel:{
                interval:0,
                textStyle:{color:'#000',fontSize:'14'}
            },
            data : dayList,
            splitLine : {
                show:true,
                lineStyle: {
                    color: '#483d8b',
                    type: 'dashed',
                    width: 1
                }
            },
            splitArea : {
                show: true,
                areaStyle:{
                    color:['rgba(240,240,240,0.3)','rgba(102,102,102,0.2)']
                }
            }
        }
    ],
    yAxis : [
        {
            name:'元',
            nameTextStyle:{
                color:'#000',
                fontSize:'16',
                fontFamily:'Microsoft YaHei'
            },
            min:0,
            max:max,
            type : 'value',
            axisLine:{lineStyle:{color:'rgba(255,215,0,0.0)'}},
            axisLabel:{textStyle:{color:'#000',fontSize:'14'}},
            splitLine : {
                show:true,
                lineStyle: {
                    color: '#483d8b',
                    type: 'dotted',
                    width: 2
                }
            },
            splitArea : {
                show: true,
                areaStyle:{
                    color:['rgba(255,248,103,0.7)','rgba(138,255,137,0.3)']
                }
            }
        }
    ],
    series : [
        {
            name:'车线成本',
            type:'line',
            data:data,
            smooth:true,
            itemStyle: {                // 系列级个性化
                normal: {
                    borderWidth: 1,
                    borderColor:'#000',
                    color: '#000',
                    areaStyle: {type: 'default',color:'rgba(102,102,102,0.3)'}
                }
            }
        }
    ]
};
    myChart.setOption(option);
    }

    function show(originData,total,startday) {    
        var dayList = [],
            dataMap = {},   
            dataMap3 = {};

        for(var i = originData.length - 1; i >= 0 ; i--){
            if(originData[i]["inday"] == startday){
                st = i;
                break;
            }
        }

        for(var i = st - 1; i >= 0 ; i--){
            if(originData[i]["inday"] != startday){
                st = i;
                break;
            }
        }

        for(var i = st + 1; i < originData.length; i++) {
            var day = originData[i]["inday"];
            if( !dayList.contains(day) ){
                dayList.push(day);
            }

            var r = originData[i]["center"];
            if(dataMap[r] == null) {
                 dataMap[r] = [];                 
            }

            dataMap[r][day] = originData[i]["fee"];

            var center = originData[i]["company"];
            dataMap[r].parents = center;

            if(dataMap3[center] == null) {
                 dataMap3[center] = [];                 
            }

            if(dataMap3[center][day] == null){
                dataMap3[center][day] = originData[i]["fee"];
            }
            else{
                dataMap3[center][day] += originData[i]["fee"];
            }

            if(dataMap3[total] == null) {
                 dataMap3[total] = [];                 
            }

            if(dataMap3[total][day] == null){
                dataMap3[total][day] = originData[i]["fee"];
            }
            else{
                dataMap3[total][day] += originData[i]["fee"];
            }
        }

        for(var center in dataMap){
            for(var i=0;i<dayList.length;i++){
                if(dataMap[center][dayList[i]] == undefined){
                    dataMap[center][dayList[i]] = 0;
                }
            }
        }

        for(var center in dataMap3){
            for(var i=0;i<dayList.length;i++){
                if(dataMap3[center][dayList[i]] == undefined){
                    dataMap3[center][dayList[i]] = 0;
                }
            }
        }

        dayList[dayList.length] = '累计';
        var cHtml = [];       
        for(var i=0; i < dayList.length; i++) {         
            if (i<dayList.length-1){
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">' + dayList[i] + '</th>');
            }
            else{
                cHtml.push('<th field="' + dayList[i] + '" width="90" align="right" formatter="formatter" styler="styler">累计</th>');
            }
        }
        
        $$("cityColumn").innerHTML = cHtml.join("\n");

        
        var data = {};
        data.rows = [];
        data.footer = [];
        for(var center in dataMap) {
             var row = {};
             var k = 0;
             row.name = center;     
             for(var i = 0; i < dayList.length; i++) {
                row[dayList[i]] = dataMap[center][dayList[i]] || 0;

                if(i == dayList.length-1){
                    row[dayList[i]] = k;
                }
                else{
                    k += dataMap[center][dayList[i]] || 0;
                }
             }
             data.rows.push(row);      
        }

        for(var center in dataMap3) {
             var row = {};
             var k = 0;
             row.name = center;          
             for(var i = 0; i < dayList.length; i++) {
                row[dayList[i]] = dataMap3[center][dayList[i]]|| 0;

                 if(i == dayList.length-1){
                    row[dayList[i]] = k;
                 }
                 else{
                    k += dataMap3[center][dayList[i]] || 0;
                }
             }
            if (center != total) {data.rows.push(row);} else{data.footer.push(row);};  
        }

        for(var center in dataMap) {
            if(dataMap[center].parents != undefined){
                p[center] = dataMap[center].parents;
            }
        }

        var rank1 = [];
        var rank2 = []; 
        var no = 1;
        for(i = 0; i < data.rows.length; i++){
            if(data.rows[i].name.indexOf('公司') >= 0){
                data.rows[i].id = no;
                no++;
                rank1.push(data.rows[i]);
                data.rows[i].state = "closed";

                for(j = 0; j < data.rows.length; j++){
                    var temp = p[data.rows[j].name];
            
                    if(temp == data.rows[i].name){
                        data.rows[j].id = no;
                        data.rows[j]._parentId = data.rows[i].id;
                        no++;
                        rank2.push(data.rows[j]);
                    }
                }
            }
        }

        dataA = data;
        Len = data.rows.length;

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }
       

    function reset(){
        if(Len){
            for(var i=Len;i>0;i--){
                $('#detailTable').treegrid('remove',i);
            }
        }
        
        var rank1 = [];
        var rank2 = []; 
        var no = 1;
        for(i = 0; i < dataA.rows.length; i++){
            if(dataA.rows[i].name.indexOf('公司') >= 0){
                dataA.rows[i].id = no;
                no++;
                rank1.push(dataA.rows[i]);
                dataA.rows[i].state = "closed";

                for(j = 0; j < dataA.rows.length; j++){
                    var temp = p[dataA.rows[j].name];
            
                    if(temp == dataA.rows[i].name){
                        dataA.rows[j].id = no;
                        dataA.rows[j]._parentId = dataA.rows[i].id;
                        no++;
                        rank2.push(dataA.rows[j]);
                    }
                }
            }
        }

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: dataA
        });

        Len = dataA.rows.length;
    }

    function select(){
        var originData = globalValiable.data,
            center = document.getElementById('center2').value,
            max = document.getElementById('maxs').value,
            min = document.getElementById('mins').value,
            data = [],
            no = 1,
            centerList = [];

        for(var i = st + 1; i < originData.length; i++) {
            var cen = originData[i]["center"],
                com = originData[i]["company"];
            if((!centerList.contains(cen))&&(center.indexOf(com)>=0)){
                centerList.push(cen);
            }
        }

        if(Len){
            for(var i=Len;i>0;i--){
                $('#detailTable').treegrid('remove',i);
            }
        }

        for(var i=0;i<dataA.rows.length;i++){
            if((dataA.rows[i].累计>=min)&&(dataA.rows[i].累计<=max)){
                if((center == '全网')||(centerList.contains(dataA.rows[i].name))||
                    (dataA.rows[i].name == center)){
                    var temp = dataA.rows[i];
                    temp.id = no;
                    temp.state = 'open';
                    data.push(temp);
                    no++
                }              
            }  
        }

        Len = data.length;

        $('#detailTable').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }
        
        function styler(value,row,index){
            return 'color:#389562;font-weight:bold;';
        }

        function formatter(value, row, index){
            if(value == ''){
                return value;
            }
            else{
                return formatMoney(value, 1);
            }
        }

        function formatMoney(s, n) {   
           n = n > 0 && n <= 20 ? n : 2;   
           s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
           var l = s.split(".")[0].split("").reverse(),   
           r = s.split(".")[1];   
           t = "";   
           for(i = 0; i < l.length; i ++ ) {   
              t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
           }   
           return t.split("").reverse().join("") + "." + r;   
        } 



    
    </script>

    <style type="text/css">
        dt {font-family:Microsoft YaHei;font-size:20px;}
        dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
    </style>
</head>

<body>
    <div class="easyui-tabs" data-options='fit:true'>
        <div title="走势图" style="font-family:Microsoft YaHei;font-size:16px;">
            选择: <select id="center" style="font-family:Microsoft YaHei;font-size:16px;" onchange="painting()">  
            <option value="全网">全网</option>    
            </select>&nbsp;
            <button id='repainting' onClick='painting()' style="width:60px;font-family:Microsoft YaHei;font-size:16px;">刷新</button>
            <div style='float:right;'>
                <input class="easyui-searchbox" data-options="prompt:'请输入查询分拨名称',searcher:doSearch" style="font-family:Microsoft YaHei;font-size:16px;"></input>
                <script>
                    function doSearch(value){
                        var inform = document.getElementById("center"),
                            selected = [];

                        for(var i=0;i <inform.options.length;i++){
                            if((inform.options[i].value.indexOf(value) >= 0)&&
                                (value.length > 0)){
                               selected.push(inform.options[i].value);
                            }
                        }

                        if(selected[1] != undefined){
                            var company,
                                center,
                                len = 100;
                            for(var i=0;i <selected.length;i++){
                                if(selected[i].indexOf('分公司') >= 0){
                                    company = i;
                                }
                                else{
                                    if((selected[i].length - value.length) < len){
                                        len = selected[i].length;
                                        center = i;
                                    }
                                }
                            }

                            if(confirm('是否查询' + selected[company] + '?')){
                                inform.value = selected[company];
                            }
                            else{
                                inform.value = selected[center];
                            }
                            painting();
                        }
                        else if(selected[0] != undefined){
                            inform.value = selected[0];
                            painting();
                        }
                    }
                </script>
            </div>
            <div id='container'style="height:640px;border:1px solid #ccc;padding:10px;"></div>
        </div>
        <div title="细节表" style="font-family:Microsoft YaHei;font-size:16px;">
            <div style="font-family:Microsoft YaHei;font-size:16px;">
                选择: <select id="center2" style="font-family:Microsoft YaHei;font-size:16px;" onchange="painting()">  
                <option value="全网">全网</option>    
                </select>&nbsp;
                大于：<input class="easyui-numberbox" id='mins' style="width:25px;font-family:Microsoft YaHei;font-size:16px;"></input>
                小于：<input class="easyui-numberbox" id='maxs'style="width:25px;font-family:Microsoft YaHei;font-size:16px;"></input>
                <button id='select' onClick='select()' style="width:60px;font-family:Microsoft YaHei;font-size:16px;">筛选</button>
                <button id='reset' onClick='reset()' style="width:60px;font-family:Microsoft YaHei;font-size:16px;">重置</button>
            </div>
            <table id="detailTable" >
                <thead frozen="true">
                    <tr>
                        <th field="name" width="200">名称</th>
                    </tr>
                </thead>
                <thead>
                    <tr id="cityColumn"></tr>
                </thead>
            </table>
        </div>  
        <div title="说明书">
            <dl>
            <dt>取值逻辑</dt>
            <dd>- 根据当天任务单的出发时间，获取任务单中车线、成本等相关数据</dd>
            <dt>时间节点</dt>
            <dd>- 当日12:00AM至次日12:00AM</dd>
            <dt>注意点</dt>
            <dd>- 细节表中的成本，且以出发分拨或分公司为归集主体</dd>
            <dd>- 12月3日数据异常，乃系统问题，近期将修正，请勿参考12月3日数据</dd>
            </dl>
        </div>
    </div>
</body>
</html>