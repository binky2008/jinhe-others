<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>中转率</title>

	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../../dm/common.css">

	<script src="../../tools/easyui/jquery.min.js"></script>
	<script src="../../tools/easyui/jquery.easyui.min.js"></script>

	<script src="../../framework/core.js"></script>
	<script src="../../framework/ajax.js"></script>
	<script src="../../dm/common.js"></script>

	<script type="text/javascript">
	window.onload = function(){
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;

            if(queryParams.param3 == '-1'){
                show(globalValiable.data,true);
            }
            else{
                show(globalValiable.data,false);
            }
            return;
        }
    } 

    function show(originData,Net){
    	var CompanyList = [],DayList = [],cHtml = [],
            RowNo = 1,matrix = [],matrix2 = [],data = {rows:[],footer:[]};

    	matrix['net'] = [];
        matrix2['net'] = [];
        matrix['net']['total'] = {op:0,w:0};
    	for(var i = 0;i < originData.length;i++){
    		var inday = originData[i]["scan_date"],
    			org = originData[i]["org_name"],
                op = originData[i]["op"]
    			w = originData[i]["w"];

    		if(!DayList.contains(inday)){
    			DayList.push(inday);
    		}
    		if(!CompanyList.contains(org)){
    			CompanyList.push(org);
    		}
    		if(matrix[org] == undefined){
    			matrix[org] = [];
                matrix2[org] = [];
    		}
    		if(matrix['net'][inday] == undefined){
    			matrix['net'][inday] = {op:0,w:0};
                matrix['net']['total'] = {op:0,w:0};
    		}
    		if(matrix[org][inday] == undefined){
    			matrix[org][inday] = {op:0,w:0};
                matrix[org]['total'] = {op:0,w:0};
    		}

    		matrix['net'][inday].w += w;
            matrix['net'][inday].op += op;
    		matrix[org][inday].w += w;
            matrix[org][inday].op += op;
            matrix['net']['total'].w += w;
            matrix['net']['total'].op += op;
            matrix[org]['total'].w += w;
            matrix[org]['total'].op += op;
    	}

        DayList.push('total');
        for(var o in matrix){
            if(o != 'contains'){
                for(var d in matrix[o]){
                    if(d != 'contains'){
                        matrix2[o][d] = matrix[o][d].op / matrix[o][d].w;
                    }
                }
            }
        }

    	if(Net){
			var temp = matrix2['net'];
	        temp.name = '全网';
	        data.footer.push(temp);
	    }

	    for(var o in CompanyList){
	    	var org = CompanyList[o];
			if(o != 'contains'){
				var temp = matrix2[org];

                temp.name = org;
                temp.id = RowNo++;
                data.rows.push(temp);
	        }
	    }

	    for(var d in DayList){
			if(d != 'contains'){
				if(DayList[d] == 'total'){
					cHtml.push('<th field="' + DayList[d] + '" width="90" align="right" formatter="formatter" styler="stylerII">累计</th>');
				}
				else{
					cHtml.push('<th field="' + DayList[d] + '" width="90" align="right" formatter="formatter" styler="styler">' + DayList[d] + '</th>');
				}
			}
		}
		$$("cityColumn").innerHTML = cHtml.join("\n");

	    $('#Tree').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }

    Array.prototype.contains = function(obj){
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    function stylerII(value,row,index){
        return 'color:#389562;font-weight:bold;background:#F3F0CD;';
    }
    
    function styler(value,row,index){
    	return 'color:#389562;font-weight:bold;';
	}

    function formatter(value, row, index){
    	if(value == undefined){
    		return '';
    	}
		else{
			return formatMoney(value,1);
		}
	}

	function formatMoney(s, n){
	   n = n > 0 && n <= 20 ? n : 2;   
	   s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
	   var l = s.split(".")[0].split("").reverse(),   
	   r = s.split(".")[1];   
	   t = "";   
	   for(i = 0; i < l.length; i ++ ) {   
	      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
	   }   
	   return t.split("").reverse().join("") + "." + r;   
	} 
	</script>
</head>
<body>
	<table id="Tree" data-options='fit:true'>
        <thead frozen="true">
            <tr>
                <th field="name" width="200">名称</th>
            </tr>
        </thead>
        <thead>
            <tr id="cityColumn"></tr>
        </thead>
    </table>
</body>
</html>