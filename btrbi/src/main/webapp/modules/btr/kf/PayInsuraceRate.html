<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>赔付额</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">
    
    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../tools/echarts-2.0.4/echarts-plain-map.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable,
        selected = 'rate',
        EatingPie = 0,
        CompanyList = [];

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
        var table = document.getElementById('DetailTable'),
            map = document.getElementById('Map'),
            pie = document.getElementById('Pie');

        map.style.height = (screen.height - 265) + 'px';
        pie.style.height = (screen.height - 265) + 'px';
        table.style.height = (screen.height - 250) + 'px';

        $('#Tab').tabs({border:false,onSelect:function(title){
            if(title == '赔付占比'){
                if(!EatingPie){
                    PiePainting();
                }
                EatingPie = 1;
            }
        }}); 

        Painting(selected);
        Table();
    } 

    function Painting(id){
        var originData = globalValiable.data,
            queryParams = globalValiable.queryParams,
            data = {},
            maxdata = 0,
            title,
            subtitle;

        data = [];
        for(var i = 0; i < originData.length; i++) {
            var value;

            if(originData[i]["type"] == '太平洋'){
                CompanyList.push(originData[i]["org_name"]);
            }

            if(id == 'rate'){
                value = originData[i]["rate"];
            }
            else if(id == 'pay'){
                value = originData[i]["pay"];
            }
            else{
                value = originData[i]["insurance"];
            }

            data.push({name: originData[i]["org_name"],value: value});

            if(value>maxdata){
                maxdata = value;
            }  
        }

        if(id == 'rate'){
            title = '全国赔付率地图';
        }
        else if(id == 'pay'){
            title = '全国赔付地图'
        }
        else{
            title = '全国保费地图'
        }

        if(queryParams.param1==queryParams.param2){
            subtitle = queryParams.param1;
        }
        else{
            subtitle = queryParams.param1+'至'+queryParams.param2;
        }

        var myChart = echarts.init(document.getElementById('Map'));

var option = {
    title : {
        text: title,
        textStyle:{fontSize:'24',fontFamily:'Microsoft YaHei'},
        subtext: subtitle,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    tooltip : {
        formatter: function(d){
            if(d[2] == '-'){
                return '';
            }
            else{
                if(selected == 'rate'){
                    return d[1] + ': ' + d[2] + '%';
                }
                else{
                    return d[1] + ': ' + d[2];
                }       
            }
        },
        textStyle:{fontSize:'14',color: '#ffffff',fontFamily:'Microsoft YaHei'}
    },
    dataRange: {
        min: 0,
        max: maxdata,
        x: 'left',
        y: 'bottom',
        text:['最高','0'],           // 文本，默认为数值文本
        calculable : true
    },
    series : [
        {
            name:'A',
            type: 'map',
            mapType: 'china',
            roam: false,
            itemStyle:{
                normal:{label:{show:true}},
                emphasis:{label:{show:true}}
            },
            data:data
        }
    ]
};              
        myChart.setOption(option);
    }

    function Table(){
        var originData = globalValiable.data,
            frozen = [],
            columns = [],
            data = [],
            ti = 0,
            tp = 0;

        frozen.push({field:'company',title:'分公司',align: 'left',width: 100});
        columns.push({field:'insurance',title:'保险额',align: 'right',width: 100});
        columns.push({field:'pay',title:'赔付额',align: 'right',width: 100});
        columns.push({field:'rate',title:'赔付率',align: 'right',width: 100});
        columns.push({field:'c',title:'保险公司',align: 'right',width: 100});

        for(var i = 0; i < originData.length; i++) {
            var c = '天安';

            if(CompanyList.contains(originData[i]["org_name"])){
                c = '太平洋';
            }

            data.push({
                'company':originData[i]["org_name"],
                'insurance':originData[i]["insurance"],
                'pay':originData[i]["pay"],
                'rate':originData[i]["rate"] + '%',
                'c':c
            });

            ti += originData[i]["insurance"];
            tp += originData[i]["pay"];
        }   
        data.push({
            'company':'全网',
            'insurance':Math.round(ti*100)/100,
            'pay':Math.round(tp*100)/100,
            'rate':Math.round(tp/ti*1000)/10 + '%'
        });  
        
        $('#DetailTable').datagrid({  
            width: 'auto',  
            height:'auto',               
            striped: true,  
            rownumbers:true,  
            frozenColumns:[frozen],   
            columns:[columns],
            data:data
        });     
    }

    function PiePainting(){
        var originData = globalValiable.data,
            queryParams = globalValiable.queryParams,
            data = {},
            data2 = {},
            data3 = {},
            data4 = {},
            tempins = 0,
            temppay = 0,
            tempins2 = 0,
            temppay2 = 0,
            subtitle;

        data = [];
        data2 = [];
        for(var i = 0; i < originData.length; i++) {
            var company = originData[i]["org_name"],
                pay = originData[i]["pay"],
                insurance = originData[i]["insurance"];

            data.push({value: pay,name:company});
            data2.push({value: insurance,name:company});

            if(CompanyList.contains(company)){
                tempins2 += originData[i]["insurance"];
                temppay2 += originData[i]["pay"];
            }
            else{
                tempins += originData[i]["insurance"];
                temppay += originData[i]["pay"];
            }

            data3 = [{value: Math.round(temppay*100)/100,name:'天安'},{value: Math.round(temppay2*100)/100,name:'太平洋'}];
            data4 = [{value: Math.round(tempins*100)/100,name:'天安'},{value: Math.round(tempins2*100)/100,name:'太平洋'}];
        }

        if(queryParams.param1==queryParams.param2){
            subtitle = queryParams.param1;
        }
        else{
            subtitle = queryParams.param1+'至'+queryParams.param2;
        }

        var myChart = echarts.init(document.getElementById('Pie'));

option = {
    title : {
        text: '赔付占比图',
        textStyle:{fontSize:'24',fontFamily:'Microsoft YaHei'},
        subtext: subtitle,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'left',
        y:'top'
    },
    tooltip : {
        show: true,
        formatter: function(d){
            if(d[1]){
                return d[1]+d[0]+':'+d[2]+'元('+d[3]+'%)';
            }
            else{
                return '';
            }
        },
        textStyle:{fontSize:'14',color: '#ffffff',fontFamily:'Microsoft YaHei'}
    },
    calculable : true,
    series : [
        {
            name:'赔付额',
            type:'pie',
            center : ['60%', '50%'],
            radius : 180,
            itemStyle : {
                normal : {
                    label : {
                        show:true,
                        position:'inner',
                        textStyle:{fontSize:'14',fontFamily:'Microsoft YaHei'},
                        formatter : function (a,b,c,d) {
                            if(d>=5){
                                return b+(d - 0).toFixed(1) + '%';
                            }
                            else{
                                return ;
                            }
                        }
                    },
                    labelLine : {
                        show : false
                    }
                },
                emphasis : {
                    label : {
                        show : true,
                        textStyle:{fontSize:'14',fontFamily:'Microsoft YaHei'},
                        formatter : function (a,b,c,d) {return b+(d - 0).toFixed(1) + '%'}
                    }
                }
                
            },
            data:data
        },
        {
            name:'保费额',
            type:'pie',
            center : ['60%', '50%'],
            radius : [220, 270],
            data:data2,
            itemStyle : {
                normal : {
                    label : {
                        textStyle:{fontSize:'14',fontFamily:'Microsoft YaHei'},
                        formatter : function (a,b,c,d) {return b+(d - 0).toFixed(1) + '%'}
                    },
                    labelLine : {
                        show : true
                    }
                },
                emphasis : {
                    label : {
                        textStyle:{fontSize:'18',fontFamily:'Microsoft YaHei'},
                        position : 'inner',
                        show : false,
                        formatter : function (a,b,c,d) {return (d - 0).toFixed(1) + '%'}
                    }
                }
                
            }
        },
        {
            name:'赔付额',
            type:'pie',
            center : ['20%', '50%'],
            radius : 80,
            itemStyle : {
                normal : {
                    label : {
                        show:true,
                        position:'inner',
                        textStyle:{fontSize:'12',fontFamily:'Microsoft YaHei'},
                        formatter : function (a,b,c,d) {
                            if(d>=5){
                                return b+(d - 0).toFixed(1) + '%';
                            }
                            else{
                                return ;
                            }
                        }
                    },
                    labelLine : {
                        show : false
                    }
                },
                emphasis : {
                    label : {
                        show : true,
                        textStyle:{fontSize:'14',fontFamily:'Microsoft YaHei'},
                        formatter : function (a,b,c,d) {return b+(d - 0).toFixed(1) + '%'}
                    }
                }
                
            },
            data:data3
        },
        {
            name:'保费额',
            type:'pie',
            center : ['20%', '50%'],
            radius : [100, 140],
            data:data4,
            itemStyle : {
                normal : {
                    label : {
                        textStyle:{fontSize:'14',fontFamily:'Microsoft YaHei'},
                        formatter : function (a,b,c,d) {return b+(d - 0).toFixed(1) + '%'}
                    },
                    labelLine : {
                        show : true
                    }
                },
                emphasis : {
                    label : {
                        textStyle:{fontSize:'18',fontFamily:'Microsoft YaHei'},
                        position : 'inner',
                        show : false,
                        formatter : function (a,b,c,d) {return (d - 0).toFixed(1) + '%'}
                    }
                }
                
            }
        }
    ]
};

        myChart.setOption(option);

    }

    $(function(){
      $(".painting").click(function(){
        if(this.id != selected){
            selected = this.id;    

            $("button").animate({
                opacity:'0.5'
            });

            $(this).animate({
              opacity:'1'
            });

            Painting(this.id);
        }
      });
    });

    </script>

    <style type="text/css">
        dt {font-family:Microsoft YaHei;font-size:20px;}
        dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
        .painting {
            opacity:0.5;
            font-family:Microsoft YaHei;
            font-size:14px;
            width:100px;
            background:#92B901; 
            color:#ffffff;
            border-radius:5px;
        } 
    </style>
</head>

<body>
    <div class="easyui-tabs" id='Tab' data-options='fit:true'>
        <div title="赔付分布" id='TabMap' style="font-family:Microsoft YaHei;font-size:16px;">
            <button class='painting' id='rate' style="opacity:1;">赔付率地图</button>
            <button class='painting' id='insurance'>保险额地图</button>
            <button class='painting' id='pay'>赔付额地图</button>
            <div id='Map' style="height:640px;"></div>
        </div>
        <div title="赔付占比" id='TabPie' style="font-family:Microsoft YaHei;font-size:16px;">
            <div id='Pie' style="height:640px;"></div>
        </div>
        <div title="细节表" id='TabTable' style="font-family:Microsoft YaHei;font-size:12px;">
            <table id="DetailTable" style="height:640px"></table>      
        </div>  
        <div title="说明书" id='TabNotice'>
            <dl>
            <dt>取值逻辑</dt>
            <dt>时间节点</dt>
            <dd>- 当日00:00至次日00:00</dd>
            <dd>- 按运单录单时间计算</dd>
            <dt>注意点</dt>
            </dl>
        </div>
    </div>
</body>
</html>