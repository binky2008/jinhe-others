<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>投诉汇总</title>
    
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <link href="../../tools/bootstrap/css/bootstrap.css" rel="stylesheet">
    <script src="../../tools/jquery/jquery-2.1.3.min.js"></script>
    <script src="../../tools/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../tools/jquery/ZeroClipboard.js"></script>

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>
    
    <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable,
      dayList = [],
        sub,
        companylist = [],
        tabH,
        EatingPie = 0;

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
        var trendcanvas = document.getElementById('trendcanvas'),
            piecanvas = document.getElementById('piecanvas'),
            table = document.getElementById('DetailTable');
        
        trendcanvas.style.height = (screen.height * 0.9091 - 178) + 'px';
        piecanvas.style.height = (screen.height * 0.9091 - 178) + 'px';
        table.style.height = (screen.height - 240) + 'px';
        tabH = screen.height - 235;

        $('#Tab').tabs({border:false,onSelect:function(title){
            if(title == '占比图'){
                if(!EatingPie){
                    PiePainting();
                }
                EatingPie = 1;
            }
        }}); 

        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;
            sub = queryParams.param1 + '至' + queryParams.param2;

      var originData = globalValiable.data;
            for(var i = 0; i < originData.length; i++) {    
                var company = originData[i]["org_name"],
                  day = originData[i]["inday"];
                if( !companylist.contains(company) ){
                    companylist.push(company);
                    document.getElementById("center")
                    .options.add(new Option(company,company));
                    document.getElementById("center2")
                    .options.add(new Option(company,company));
                }
            }

            var StratDay = new Date(queryParams.param1);
            var EndDay = new Date(queryParams.param2);
            dayList.push(DayTrans(StratDay));
            while(StratDay < EndDay){
                StratDay = new Date(StratDay.setDate(StratDay.getDate() + 1));
                dayList.push(DayTrans(StratDay));
            }

            $("#Tab1").click();
            TrendPainting();
            PiePainting();
            ShowTable();
            return;
        }
    } 


    function PiePainting(){
      var selected = document.getElementById('center2').value,
        originData = globalValiable.data,
            n = [],
            b = [],
            s = [],
            l = [],
            d = [],
            tp = [],
            DataCompany = {},
            DataProblem = {},
            DataType = {},
            broken = 0,
            shortage = 0,
            lost = 0,
            delay = 0;

      for(var i = 0; i < originData.length; i++) {
        var center = originData[i]["org_name"];
            if((selected == '全网')||(center == selected)){
            if(n[center] == null){
                    n[center] = 0;
                    b[center] = 0;
                    s[center] = 0;
                    l[center] = 0;
                    d[center] = 0;
            }    

          n[center] += originData[i]["num"];
          b[center] += originData[i]["b"];
          s[center] += originData[i]["s"];
          l[center] += originData[i]["l"];
          d[center] += originData[i]["d"];

                var type = originData[i]["sitetype"];
                if(tp[type] == null){
                    tp[type] = 0;
                }
                tp[type] += originData[i]["num"];
            }
      }

        DataType = [];
        for(var type in tp){
            if(type != 'contains'){
                DataType.push({value: tp[type],name:type});
            }
        }

        DataCompany = [];
        for(var center in n){
            if(center != 'contains'){
                DataCompany.push({value: n[center],name:center});
                broken += b[center];
                lost += l[center];
                shortage += s[center];
                delay += d[center];
            }
        }

        DataProblem = [];
        if(delay > 0){
            DataProblem.push({value: delay,name:'延误'});
        }
        if(shortage > 0){
            DataProblem.push({value: shortage,name:'短少'});
        }
        if(broken > 0){
            DataProblem.push({value: broken,name:'破损'});
        }
        if(lost > 0){
            DataProblem.push({value: lost,name:'遗失'});
        }

        var myChart = echarts.init(document.getElementById('piecanvas'));
///////////////////////////////OPTION
option = {
    title : {
        text: '投诉占比图',
        textStyle:{fontSize:'24',fontFamily:'Microsoft YaHei'},
        subtext: sub,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'left',
        y:'top'
    },
    tooltip : {
        show: true,
        formatter: function(d){
            if(d[1]){
                return d[1]+':'+d[2]+'件('+d[3]+'%)';
            }
            else{
                return '';
            }
        },
        textStyle:{fontSize:'14',color: '#ffffff',fontFamily:'Microsoft YaHei'}
    },
    calculable : true,
    series : [
        {
            name:'投诉类型',
            type:'pie',
            center : ['50%', '50%'],
            radius : 80,
            itemStyle : {
                normal : {
                    label : {
                        position : 'inner',
                        formatter : function (a,b,c,d) {return (d - 0).toFixed(0) + '%'}
                    },
                    labelLine : {
                        show : false
                    }
                },
                emphasis : {
                    label : {
                        show : true,
                        formatter : function (a,b,c,d) {return (d - 0).toFixed(0) + '%'}
                    }
                }
                
            },
            data:DataProblem,
            markPoint: {
                symbol:'emptyCircle',
                symbolSize:1,
                effect:{show:true,scaleSize:850,color:'rgba(250,225,50,0.8)',shadowBlur:10,period:30},
                data:[{x:'50%',y:'50%'}]
            }
        },
        {
            name:'投诉来自',
            type:'pie',
            center : ['50%', '50%'],
            radius : [110, 140],
            data:DataType,
            itemStyle : {
                normal : {
                    label : {
                        position : 'inner',
                        formatter : function (a,b,c,d) {return (d - 0).toFixed(0) + '%'}
                    },
                    labelLine : {
                        show : false
                    }
                },
                emphasis : {
                    label : {
                        show : true,
                        formatter : function (a,b,c,d) {return (d - 0).toFixed(0) + '%'}
                    }
                }
                
            }
        },
        {
            name:'省份投诉占比',
            type:'pie',
            center : ['50%', '50%'],
            radius : [160, 200],
            data:DataCompany
        }
    ]
};

        myChart.setOption(option);
    }

    function TrendPainting(){
        var selected = document.getElementById('center').value,
            type = document.getElementById('type3').value,
            originData = globalValiable.data,
            DataTrend = [],
            data = [],
            max = 0;

        for(var day in dayList){
            if(day != 'contains'){
                DataTrend[dayList[day]] = 0;
            }   
        }

        for(var i = 0; i < originData.length; i++) {
            var center = originData[i]["org_name"];
            if((selected == '全网')||(center == selected)){
                var day = originData[i]["inday"];

                switch(type){
                    case 'all':
                        DataTrend[day] += originData[i]["num"];
                        break;
                    case 'delay':
                        DataTrend[day] += originData[i]["d"];
                        break;
                    case 'lost':
                        DataTrend[day] += originData[i]["l"];
                        break;
                    case 'shortage':
                        DataTrend[day] += originData[i]["s"];
                        break;
                    case 'broken':
                        DataTrend[day] += originData[i]["b"];
                        break;
                    default:
                        DataTrend[day] += originData[i]["num"];
                        break;
                }
            }
        }
        
        for(var day in DataTrend){
            data.push(DataTrend[day]);

            if(DataTrend[day] > max){
                max = Math.ceil(DataTrend[day]/10)*10;
            }   
        }

       var myChart = echarts.init(document.getElementById('trendcanvas'));
 ///////////////////////////////////Option
        var option = {
    title : {
        text:'投诉走势图',
        textStyle:{fontSize:'24',color:'#000',fontFamily:'Microsoft YaHei'},
        subtext:sub,
        subtextStyle:{fontSize:'18',color: '#999999',fontFamily:'Microsoft YaHei'},
        x:'center'
    },
    tooltip : {
        trigger: 'axis',
        backgroundColor:'rgba(255,226,141,0.7)',
        textStyle:{fontSize:'16',color:'#000',fontFamily:'Microsoft YaHei'},
        axisPointer:{type:'line',lineStyle:{color: '#FF7F24',width: 1}}
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#999999'}},
            boundaryGap : false,
            axisLabel:{
                interval:0,
                textStyle:{color:'#999999',fontSize:'12'}
            },
            data : dayList
        }
    ],
    yAxis : [
        {
            name:'',
            type : 'value',
            axisLine:{lineStyle:{color:'#999999'}},
            axisLabel:{textStyle:{color:'#999999',fontSize:'12'}},
            min:0,
            max:max
        }
    ],
    series : [
        {
            name:'投诉',
            type:'line',
            data:data,
            itemStyle:{
                normal:{
                    borderWidth:6,borderColor:'#FF7F24'
                }
            },
            markPoint:{
                data : [{type : 'max', name: '最大值'}],
                symbol:'star7',
                symbolSize:25,
                itemStyle:{
                    normal : {
                        color:'#FF7F24'
                    }
                }
            }
        }
    ]
};            
        myChart.setOption(option);
    }

    function ShowTable(){
        var originData = globalValiable.data,
            selected = document.getElementById('type').value,
            detailtype = document.getElementById('type2').value,
            frozen = [],
            columns = [],
            data = [],
            datap = [],
            data2 = [],
            CenterList = [],
            total = [],
            sendtotal = [],
            companyday = [];

        frozen.push({field:'名称',title:'省份',align: 'left',width: 100});
        for(var day in dayList){
            if(day != 'contains'){
                columns.push({field:day,title:dayList[day],align: 'right',width: 80});
            }   
        }
        columns.push({field:'累计',title:'累计',align: 'right',width: 80});

        for(var day in dayList){
            for(var company in companylist){
                if((day != 'contains')&&(company != 'contains')){
                    total[companylist[company]] = 0;
                    sendtotal[companylist[company]] = 0;
                    
                    if(data[dayList[day]] == null){
                        data[dayList[day]] = [];
                        datap[dayList[day]] = [];

                    }
                    data[dayList[day]][companylist[company]] = 0;
                    datap[dayList[day]][companylist[company]] = 0.0000000001;
                }
            }
        }
        data['累计'] = total;
        datap['累计'] = sendtotal;

        for(var i = 0; i < originData.length; i++) {
            var day = originData[i]["inday"],
                company = originData[i]["org_name"],
                n,sn;

                sn = originData[i]["sendnum"];
                switch(selected){
                    case 'all':
                        n = originData[i]["num"];
                        break;
                    case 'delay':
                        n = originData[i]["d"];
                        break;
                    case 'lost':
                        n = originData[i]["l"];
                        break;
                    case 'shortage':
                        n = originData[i]["s"];
                        break;
                    case 'broken':
                        n = originData[i]["b"];
                        break;
                    default:
                        n = originData[i]["num"];
                        break;
                }

                data[day][company] += n;
                data['累计'][company] += n;

                var t = day + company;
                if(!companyday.contains(t)){
                    companyday.push(t);
                    datap['累计'][company] += sn;
                }
                datap[day][company] = sn;
                
        }

        data2 = [];
        for(var company in companylist){
            var row = {};
            row = [];

            row.名称 = companylist[company];
            for(var day in dayList){
                if(day != 'contains'){
                    if(detailtype == 'Number'){
                        row[day] = data[dayList[day]][companylist[company]];
                    }
                    else if(detailtype == 'Percent'){
                        row[day] = Math.round(data[dayList[day]][companylist[company]]/datap[dayList[day]][companylist[company]]*100000)/1000 +'%';
                    }
                    else{
                        row[day] = Math.round(data[dayList[day]][companylist[company]]/datap[dayList[day]][companylist[company]]*1000000)/1000 +'‰';
                    }
                }
            }
            if(detailtype == 'Number'){
                row.累计 = data['累计'][companylist[company]];
            }
            else if(detailtype == 'Percent'){
                row.累计 = Math.round(data['累计'][companylist[company]]/datap['累计'][companylist[company]]*100000)/1000 + '%';
            }
            else{
                row.累计 = Math.round(data['累计'][companylist[company]]/datap['累计'][companylist[company]]*1000000)/1000 + '‰';
            }

            if(company != 'contains'){
                data2.push(row);
            }
        }

        $('#DetailTable').datagrid({  
            width: 'auto',  
            height:tabH,               
            striped: true,      
            frozenColumns:[frozen],   
            columns:[columns],
            data:data2
        });  
    }

    function DayTrans(day){
        var res = day.getYear() + 1900 + '-';

        if(day.getMonth() < 11){
            res += '0';
        }
        res += day.getMonth() + 1 + '-' ;

        if(day.getDate() < 10){
            res += '0';
        }
        res += day.getDate();

        return res;
    }

  function Screen(id) {
    var clip = new ZeroClipboard.Client(); 
    clip.setHandCursor( true ); 
    clip.setText('复制内容'); 
    clip.glue('CBtn'); 
}






    </script>

   <style type="text/css">
      dt {font-family:Microsoft YaHei;font-size:20px;}
      dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
      #CenterSelect {
       font-family:Microsoft YaHei;
       font-size:18px;
       float:right;
       padding:8px;
       color:#999;
       border-color:#fff;
       text-align:right;
   }
    .navcustom{
        font-family:Microsoft YaHei;
        text-align: center;
        color:#337AB7;
        width: 140px;
        margin-top: 20px;
        margin-left: 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.067);
    }
    .navcustom li{
        margin: 0;
        border-top: 1px solid #ddd;
    }
    .navcustom li:first-child{
        border-top: none;
    }
    .navcustom li a{
        margin: 0;
        padding: 8px 16px;
        border-radius: 0;
    }
    .navcustom li.active a, ul.nav-tabs li.active a:hover{
        color: #fff;
        background: #0088cc;
        border: 1px solid #0088cc;
    }
    .navcustom li:first-child a{
        border-radius: 4px 4px 0 0;
    }
    .navcustom li:last-child a{
        border-radius: 0 0 4px 4px;
    }
    .navcustom.affix{
        top: 30px; /* Set the top position of pinned element */
    }
   </style>
</head>

<body>
<ul id="myTab" class="nav nav-tabs">
   <li class="Tab"><a  id='Tab1' href="#TabTrend" data-toggle="tab">走势图</a></li>
   <li class="Tab"><a href="#TabPie" data-toggle="tab">占比图</a></li>
   <li class="Tab"><a href="#TabTable" data-toggle="tab">明细表</a></li>
   <li class="Tab"><a href="#Notice" data-toggle="tab">说明书</a></li>
</ul>

<div id="myTabContent" class="tab-content">
   <div class="tab-pane fade in active" id="TabTrend">
    省份选择: <select id="center" style="font-family:Microsoft YaHei;font-size:16px;" onchange="TrendPainting()">  
  <option value="全网">全网</option>   
    </select>&nbsp;
    投诉类型: <select id="type3" style="font-family:Microsoft YaHei;font-size:16px;" onchange="TrendPainting()">  
    <option value="all">全部</option>  
    <option value="delay">延误</option>   
    <option value="lost">遗失</option>   
    <option value="shortage">短少</option>   
    <option value="broken">破损</option>    
    </select>&nbsp;  
    <button type="button" id="CBtn" onclick="Screen('trendcanvas')" class="btn btn-success">截图</button>
    <div id='trendcanvas' style="height:640px;border:1px solid #ccc;padding:10px;"></div>
   </div>

   <div class="tab-pane fade in active" id="TabPie">
      省份选择: <select id="center2" style="font-family:Microsoft YaHei;font-size:16px;" onchange="PiePainting()">  
      <option value="全网">全网</option>   
      </select>&nbsp;         
      <button id='repainting' onClick='PiePainting()' style="width:60px;font-family:Microsoft YaHei;font-size:16px;">重置</button>
      <div id='piecanvas' style="height:640px;border:1px solid #ccc;padding:10px;"></div>
   </div>

    <div class="tab-pane fade" id="TabTable">
      投诉类型: <select id="type" style="font-family:Microsoft YaHei;font-size:16px;" onchange="ShowTable()">  
      <option value="all">全部</option>  
      <option value="delay">延误</option>   
      <option value="lost">遗失</option>   
      <option value="shortage">短少</option>   
      <option value="broken">破损</option>    
      </select>&nbsp;
      统计类型: <select id="type2" style="font-family:Microsoft YaHei;font-size:16px;" onchange="ShowTable()">  
      <option value="Number">件数</option>  
      <option value="Percent">百分比</option>   
      <option value="PerMil">千分比</option>    
      </select>&nbsp;
      <div class="easyui">
        <table id="DetailTable" class="easyui-datagrid"></table> 
      </div>
    </div>
    <div class="tab-pane fade" id="Notice">
      <dl>
      <dt>取值逻辑</dt>
      <dd>- 投诉件数去当天审批的破损、遗失、短少、延误件数之和，投诉率按照投诉件数与当日发件数之比，单位为十万分之一</dd>
      <dt>时间节点</dt>
      <dd>- 前一日18:00至当日18:00</dd>
      <dd>- 按判责时间计算</dd>
      <dt>注意点</dt>
      </dl>
  </div>
</div>
</body>
</html>