<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>理赔及时处理率</title>

   <link href="../../tools/bootstrap/css/bootstrap.css" rel="stylesheet">
   <script src="../../tools/jquery/jquery-2.1.3.min.js"></script>
   <script src="../../tools/bootstrap/js/bootstrap.min.js"></script>

   <script src="../../framework/core.js"></script>
   <script src="../../framework/ajax.js"></script>
   <script src="../../dm/common.js"></script>

   <script src="../../tools/echarts-2.0.4/echarts-plain.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable;

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    window.onload = function() {
//////////////////////////调整画布高度
        var originData = globalValiable.data,
            trend = document.getElementById('TrendCanvas');
        trend.style.height = (screen.height - 265) + 'px';

        var personlist = [],
            List = document.getElementById("Select");
        for(var i = 0; i < originData.length; i++){
            var n = originData[i]["name"];

            if(!personlist.contains(n)){
                personlist.push(n);
                List.options.add(new Option(n,n));
            }
        }

        $("#Tab1").click();
        Painting();
        TableSummary();
    } 

    function Painting(){
        var originData = globalValiable.data,
            queryParams = globalValiable.queryParams,
            DayList = [],
            PersonList = [],
            data = {},
            datainday = [],
            dataT = [],
            matrix = {},
            series = [];

////////////////////////////把起始结束时间填充完整
        var StratDay = new Date(queryParams.param1),
            EndDay = new Date(queryParams.param2);
        DayList.push(DayTrans(StratDay));
        while(StratDay < EndDay){
            StratDay = new Date(StratDay.setDate(StratDay.getDate() + 1));
            DayList.push(DayTrans(StratDay));
        }

///////////////////////////////数据部分
        matrix = [];
        data = [];
        for(var i = 0; i < originData.length; i++) {
            var pd = originData[i]["name"] + originData[i]["inday"],
                person = originData[i]["name"],
                inday = originData[i]["inday"];

            if(!PersonList.contains(person)){
                PersonList.push(person);        
                data[person] = [];
            }

            if(dataT[inday] == null){
                dataT[inday] = {};
                dataT[inday].n = 0;
                dataT[inday].tn = 0;
            }

            matrix[pd] = {};
            matrix[pd].n = originData[i]["n"];
            matrix[pd].tn = originData[i]["tn"];
            dataT[inday].n += originData[i]["n"];
            dataT[inday].tn += originData[i]["tn"];
        }

        for(d in DayList){
            if(d != 'contains'){
                if(dataT[DayList[d]] != undefined){
                    datainday.push(Math.round(dataT[DayList[d]].n/dataT[DayList[d]].tn*1000)/10);
                }
                else{
                    datainday.push(dataT[DayList[d]]);
                }   
            }

            for(var p in PersonList){
                if((d != 'contains') && (p != 'contains')){
                    var pd = PersonList[p] + DayList[d];
                    if(matrix[pd] != undefined){
                        data[PersonList[p]].push(Math.round(matrix[pd].n/matrix[pd].tn*1000)/10);
                    }
                    else{
                        data[PersonList[p]].push(matrix[pd]);
                    }
                }
            }
        }

/////////////////////////////////添加系列
        var selected = document.getElementById('Select').value,
            datafinal = [],
            name
        if(selected == 'all'){
            datafinal = datainday;
        }
        else{
            datafinal = data[selected];
        }

       series.push({
       name:'叫什么不重要',
       type:'line',
       smooth:true,
       data:datafinal,
       symbol:'none',
       itemStyle: {
          normal: {
             lineStyle: {        // 系列级个性化折线样式
                width: 3,
                color:'#337AB7'
             }
         }
       }
       });

/////////////////////////////////画图部分
        var myChart = echarts.init(document.getElementById('TrendCanvas'));

var option = {
    tooltip : {
        trigger: 'axis',
        axisPointer:{type : 'none'},
        textStyle:{fontSize:'16',color:'#fff',fontFamily:'Microsoft YaHei'},
        formatter:function(d){
            if(d[0][2] != '-'){
                return d[0][1].substr(d[0][1].indexOf('-') + 1) + ': ' + d[0][2] + '%';
            }
            else{
                return d[0][1].substr(d[0][1].indexOf('-') + 1) + ': ' + '-';
            }
        }
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#999'}},
            boundaryGap : false,
            axisLabel:{
                rotate:-30,
                interval:0,
                textStyle:{color:'#999',fontSize:'16'}
            },
            data : DayList
        }
    ],
    yAxis : [
        {
            name:'百分比',
            nameTextStyle:{
                fontSize:'16',
                fontFamily:'Microsoft YaHei'
            },
            type : 'value',
            axisLine:{lineStyle:{color:'#999'}},
            axisLabel:{textStyle:{color:'#999',fontSize:'16'}},
            min:0,
            max:100
        }
    ],
    series : series
};            
       myChart.setOption(option);
    }

    function DayTrans(day){
        var res = day.getYear() + 1900 + '-';

        if(day.getMonth() < 11){
            res += '0';
        }
        res += day.getMonth() + 1 + '-' ;

        if(day.getDate() < 10){
            res += '0';
        }
        res += day.getDate();

        return res;
    }

    function TableSummary(){
        var originData = globalValiable.data,
            PersonList = [],
            data = [];


        for(var i = 0; i < originData.length; i++) {
            var person = originData[i]["name"];

            if(!PersonList.contains(person)){
                PersonList.push(person);        
                data[person] = {};
                data[person].n = 0;
                data[person].tn = 0;
            }

            data[person].n += originData[i]["n"];
            data[person].tn += originData[i]["tn"];
        }

////////////////////////////制表
        var table = document.getElementById("tablesummary");
        var h = table.createTHead().insertRow();

        var td = h.insertCell(0);  
        td.innerText = '处理人';
        td.style.color = '#999';
        td.style.fontFamily = 'Microsoft YaHei';

        var td = h.insertCell(1);  
        td.innerText = '及时处理次数';
        td.style.color = '#999';
        td.style.fontFamily = 'Microsoft YaHei';

        var td = h.insertCell(2);  
        td.innerText = '未及时处理次数';
        td.style.color = '#999';
        td.style.fontFamily = 'Microsoft YaHei';

        var td = h.insertCell(3);  
        td.innerText = '总处理次数';
        td.style.color = '#999';
        td.style.fontFamily = 'Microsoft YaHei';

        var td = h.insertCell(4);  
        td.innerText = '及时处理率';
        td.style.color = '#999';
        td.style.fontFamily = 'Microsoft YaHei';

        for(p in PersonList){
            if(p != 'contains'){
                var tr = table.insertRow();

                var td = tr.insertCell(0);  
                td.innerText = PersonList[p];
                td.style.fontFamily = 'Microsoft YaHei';

                var td = tr.insertCell(1);  
                td.innerText = data[PersonList[p]].n;
                td.style.fontFamily = 'Microsoft YaHei';

                var td = tr.insertCell(2);  
                td.innerText = data[PersonList[p]].tn - data[PersonList[p]].n;
                td.style.fontFamily = 'Microsoft YaHei';

                var td = tr.insertCell(3);  
                td.innerText = data[PersonList[p]].tn;
                td.style.fontFamily = 'Microsoft YaHei';

                var td = tr.insertCell(4);  
                td.innerText = Math.round(data[PersonList[p]].n/data[PersonList[p]].tn*1000)/10 + '%';
                td.style.fontFamily = 'Microsoft YaHei';
            }
        }
    }
    </script>

   <style type="text/css">
      dt {font-family:Microsoft YaHei;font-size:20px;}
      dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
      th {
        color:#999;
        font-family:Microsoft YaHei;
        font-style:normal;
      }
      td{
        font-family:Microsoft YaHei;
      }
      .btn {font-family:Microsoft YaHei;}
      .Tab {font-family:Microsoft YaHei;}
      #Select {
       font-family:Microsoft YaHei;
       font-size:18px;
       float:right;
       padding:8px;
       color:#999;
       border-color:#fff;
       text-align:right;
      }
/* Custom Styles */
    .navcustom{
        font-family:Microsoft YaHei;
        text-align: center;
        color:#337AB7;
        width: 140px;
        margin-top: 20px;
        margin-left: 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.067);
    }
    .navcustom li{
        margin: 0;
        border-top: 1px solid #ddd;
    }
    .navcustom li:first-child{
        border-top: none;
    }
    .navcustom li a{
        margin: 0;
        padding: 8px 16px;
        border-radius: 0;
    }
    .navcustom li.active a, ul.nav-tabs li.active a:hover{
        color: #fff;
        background: #0088cc;
        border: 1px solid #0088cc;
    }
    .navcustom li:first-child a{
        border-radius: 4px 4px 0 0;
    }
    .navcustom li:last-child a{
        border-radius: 0 0 4px 4px;
    }
    .navcustom.affix{
        top: 30px; /* Set the top position of pinned element */
    }
   </style>
</head>

<body>

<ul id="myTab" class="nav nav-tabs">
   <li class="Tab"><a  id='Tab1' href="#Trend" data-toggle="tab">走势图</a></li>
   <li class="Tab"><a href="#SummaryTable" data-toggle="tab">汇总表</a></li>
   <li class="Tab"><a href="#Notice" data-toggle="tab">说明书</a></li>
</ul>

<div id="myTabContent" class="tab-content">
    <div class="tab-pane fade in active" id="Trend">
        <select id="Select" onchange="Painting()">
            <option value="all">全部</option>  
        </select>&nbsp;
        <div id='TrendCanvas' style="height:640px;"></div>
    </div>

    <div class="tab-pane fade" id="SummaryTable">
        <table id='tablesummary' class="table">
        <tbody>
        </tbody>
        </table>
    </div>

    <div class="tab-pane fade" id="Notice">
        <dl>
        <dt>取值逻辑</dt>
        <dt>时间节点</dt>
        <dd>- 当日18:00至次日18:00</dd>
        <dd>- 按理赔产生时间计算</dd>
        <dt>注意点</dt>
        </dl>
    </div>
</div>

</body>
</html>