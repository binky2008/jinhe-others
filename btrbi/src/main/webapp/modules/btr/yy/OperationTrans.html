<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>操作货量</title>

	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="../../dm/common.css">

	<script src="../../tools/easyui/jquery.min.js"></script>
	<script src="../../tools/easyui/jquery.easyui.min.js"></script>

	<script src="../../framework/core.js"></script>
	<script src="../../framework/ajax.js"></script>
	<script src="../../dm/common.js"></script>

	<script type="text/javascript">
	window.onload = function(){
        var globalValiable = window.parent.globalValiable;
        if(globalValiable && globalValiable.data) {
            queryParams = globalValiable.queryParams;

            if(queryParams.param3 == '-1'){
                show(globalValiable.data,true,true);
            }
            else if(queryParams.param4 == '-1'){
                show(globalValiable.data,false,true);
            }
            else{
            	show(globalValiable.data,false,false);
            }
            return;
        }
    } 

    function show(originData,Net,Org){
    	var CenterList = [],CompanyList = [],Relate = [],DayList = [],
    		cHtml = [],RowNo = 1,matrix = [],data = {rows:[],footer:[]};

    	matrix['net'] = [];
        matrix['net']['total'] = 0;
    	for(var i = 0;i < originData.length;i++){
    		var inday = originData[i]["scan_date"],
    			cen = originData[i]["name"],
    			org = originData[i]["org_name"],
    			w = originData[i]["weight"];

    		if(!DayList.contains(inday)){
    			DayList.push(inday);
    		}
    		if(!CenterList.contains(cen)){
    			CenterList.push(cen);
    		}
    		if(!CompanyList.contains(org)){
    			CompanyList.push(org);
    		}
    		if(matrix[org] == undefined){
    			matrix[org] = [];
                matrix[org]['total'] = 0;
    		}
    		if(matrix[cen] == undefined){
    			matrix[cen] = [];
                matrix[cen]['total'] = 0;
    		}
    		if(matrix['net'][inday] == undefined){
    			matrix['net'][inday] = 0;
    		}
    		if(matrix[org][inday] == undefined){
    			matrix[org][inday] = 0;
    		}
    		if(matrix[cen][inday] == undefined){
    			matrix[cen][inday] = 0;
    		}
    		if(!Relate.contains(cen)){
    			Relate[cen] = org;
    		}

    		matrix['net'][inday] += w;
    		matrix[org][inday] += w;
    		matrix[cen][inday] += w;
            matrix['net']['total'] += w;
            matrix[org]['total'] += w;
            matrix[cen]['total'] += w;
    	}

    	if(Net){
			var temp = matrix['net'];
	        temp.name = '全网';
	        data.footer.push(temp);
	    }

	    for(var o in CompanyList){
	    	var org = CompanyList[o];
			if(o != 'contains'){
				if(Org){
					var temp = matrix[org];
	                    pre_id = RowNo;

	                temp.name = org;
	                temp.id = RowNo++;
	                temp.state = 'closed';
	                data.rows.push(temp);
	            }

                for(var c in CenterList){
                	var cen = CenterList[c];
                    if((c != 'contains')&&(Relate[cen] == org)){
                        var temp = matrix[cen];

                        temp.name = cen;
                        temp.id = RowNo++;
                        if(Org){temp._parentId = pre_id;}
                        data.rows.push(temp);
                	}
                } 
	        }
	    }

        DayList.push('total');
	    for(var d in DayList){
			if(d != 'contains'){
				if(DayList[d] == 'total'){
					cHtml.push('<th field="' + DayList[d] + '" width="90" align="right" formatter="formatter" styler="stylerII">累计</th>');
				}
				else{
					cHtml.push('<th field="' + DayList[d] + '" width="90" align="right" formatter="formatter" styler="styler">' + DayList[d] + '</th>');
				}
			}
		}
		$$("cityColumn").innerHTML = cHtml.join("\n");

	    $('#Tree').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }

    Array.prototype.contains = function(obj){
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  

    function stylerII(value,row,index){
        return 'color:#389562;font-weight:bold;background:#F3F0CD;';
    }

    function styler(value,row,index){
    	return 'color:#389562;font-weight:bold;';
	}

    function formatter(value, row, index){
    	if(value == undefined){
    		return '';
    	}
		else{
			return formatMoney(value,1);
		}
	}

	function formatMoney(s, n){
	   n = n > 0 && n <= 20 ? n : 2;   
	   s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
	   var l = s.split(".")[0].split("").reverse(),   
	   r = s.split(".")[1];   
	   t = "";   
	   for(i = 0; i < l.length; i ++ ) {   
	      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
	   }   
	   return t.split("").reverse().join("") + "." + r;   
	} 
	</script>
</head>
<body>
	<table id="Tree" data-options='fit:true'>
        <thead frozen="true">
            <tr>
                <th field="name" width="200">名称</th>
            </tr>
        </thead>
        <thead>
            <tr id="cityColumn"></tr>
        </thead>
    </table>
</body>
</html>