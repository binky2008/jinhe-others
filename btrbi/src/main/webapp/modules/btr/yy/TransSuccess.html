<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>时效走势快速查询</title>

    <link rel="stylesheet" type="text/css" href="../../dm/common.css">
    <link href="../../tools/bootstrap/css/buttons.css" rel="stylesheet">
    <link href="../../tools/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../tools/bootstrap/datatable/jquery.dataTables.min.css" rel="stylesheet">

    <script src="../../tools/jquery/jquery-2.1.3.min.js"></script>
    <script src="../../tools/bootstrap/js/bootstrap.min.js"></script>
    <script src="../../tools/bootstrap/datatable/jquery.dataTables.min.js"></script>
    <script src="../../tools/jquery/ZeroClipboard.js"></script>
    <script src="../../tools/echarts-2.0.4/echarts-plain-map.js"></script>
    <script src="../zk/CityLocation.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>

    <script type="text/javascript">
    var globalValiable = window.parent.globalValiable;

    window.onload = function() {
        var originData = globalValiable.data,
            queryParams = globalValiable.queryParams,
            trend = document.getElementById('TrendCanvas');
        trend.style.height = (screen.height - 265) + 'px';

        Trend();
    } 

    function Trend(){
        var originData = globalValiable.data,
            data = [],series = [],DayList = [],orgdata = [],
            mind = [],maxd = [],mino = [],maxo = [],min,max,
            datar = [],datap = [],
            LineColor = ['#337AB7','#337AB7','#008972','#008972','#F2572D','#A488A5'];

        for(var i = 0; i < originData.length; i++){
            var inday = originData[i]["inday"],
                center = originData[i]["name"],
                org = originData[i]["org_name"],
                n = originData[i]["ts_a"],
                tn = originData[i]["ts_b"],
                temp;

            if(!DayList.contains(inday)){
                DayList.push(inday);
                orgdata[inday] = [];
                data[inday] = {n:0,tn:0};
                mind[inday] = {n:'',r:100};
                maxd[inday] = {n:'',r:0};
                mino[inday] = {n:'',r:100};
                maxo[inday] = {n:'',r:0};
            }
            if(orgdata[inday][org] == undefined){
                orgdata[inday][org] = {n:0,tn:0};
            }
            
            data[inday].n += n;
            data[inday].tn += tn;
            orgdata[inday][org].n += n;
            orgdata[inday][org].tn += tn;

            temp = (n/tn*100).toFixed(1);
            mind[inday].n = mind[inday].r > temp?center:mind[inday].n;
            mind[inday].r = mind[inday].r > temp?temp:mind[inday].r;
            maxd[inday].n = maxd[inday].r < temp?center:maxd[inday].n;
            maxd[inday].r = maxd[inday].r < temp?temp:maxd[inday].r;

            temp = (orgdata[inday][org].n/orgdata[inday][org].tn*100).toFixed(1);
            mino[inday].n = mino[inday].r > temp?org:mino[inday].n;
            mino[inday].r = mino[inday].r > temp?temp:mino[inday].r;
            maxo[inday].n = maxo[inday].r < temp?center:maxo[inday].n;
            maxo[inday].r = maxo[inday].r < temp?temp:maxo[inday].r;
        }console.log(mind);

        for(var d in DayList){
            if(d != 'contains'){
                var inday = DayList[d];
                datar.push([mino[inday].r,maxo[inday].r,mind[inday].r,maxd[inday].r]);
                datap.push((data[inday].n/data[inday].tn*100).toFixed(1));
            }
        }console.log(datar);console.log(datap);


        for(var i = 0; i < 6; i++){
            if(TrendSeries[i]){
                datalegend.push({name:SeriesName[i], textStyle:{normal:{color:'#999'}}});

                series.push({
                    name:SeriesName[i],
                    type:'line',
                    data:data[i],
                    symbol:'none',
                    itemStyle: {
                        normal: {
                            color:LineColor[i],
                            lineStyle: {   
                                type:LineType[i],
                                color:LineColor[i],
                                width: 3
                            }
                        }
                    }
                });
            }
        }

        min = Math.floor(Math.min.apply(null,mind)/10)*10;
        max = Math.ceil(Math.max.apply(null,maxd)/10)*10;

        var myChart = echarts.init(document.getElementById('TrendCanvas'));
//////////////////////////////////////////////OPTION
var option = {
    legend: {
        x:'right',
        y:'20px',
        selectedMode:false,
        data:datalegend,
        textStyle:{
            fontFamily:'Microsoft YaHei',
            fontSize:'18',
            color:'#999',
        }
    },
    tooltip : {
        trigger: 'axis',
        axisPointer:{type : 'none'},
        textStyle:{fontSize:'16',color:'#fff',fontFamily:'Microsoft YaHei'},
        formatter:function(d){
            var l = d.length,
                result = d[0][1];

            for(var i = 0;i < d.length;i++){
                if(d[i][2] != '-'){
                    result += '<br/>' + d[i][0] + ':' + d[i][2] + '%';
                }
                else{
                    result += '<br/>' + d[i][0] + ':' + '-';
                }
            }

            return result;
        }
    },
    calculable : true,
    xAxis : [
        {
            type : 'category',
            axisLine:{lineStyle:{color:'#999'}},
            boundaryGap : false,
            axisLabel:{
                rotate:-30,
                interval:0,
                textStyle:{color:'#999',fontSize:'16'}
            },
            data : DayList
        }
    ],
    yAxis : [
        {
            name:'百分比',
            nameTextStyle:{
                fontSize:'18',
                fontFamily:'Microsoft YaHei'
            },
            type : 'value',
            axisLine:{lineStyle:{color:'#999'}},
            axisLabel:{textStyle:{color:'#999',fontSize:'16'}},
            min:min,
            max:max
        }
    ],
    series : series
};            
        myChart.setOption(option);
    }

    Array.prototype.contains = function(obj) {  
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    }  
    </script>

    <style type="text/css">
        img {max-height: 100%;}
        dt {font-family:Microsoft YaHei;font-size:20px;}
        dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
        li {font-family:Microsoft YaHei;}
        th {
            color:#999;
            font-family:Microsoft YaHei;
            font-style:normal;
        }
        td{font-family:Microsoft YaHei;}
        span {width:16px;height:16px;}
        .modal-title{font-family:Microsoft YaHei;color:#337AB7;}
        .panel-heading {font-family:Microsoft YaHei;}
        .table-hover{margin-top: 15px;}
        .btn {font-family:Microsoft YaHei;}
        .copybtn {
            font-family:Microsoft YaHei;
            width:140px;
            margin-top: 3px;
        }
        .Tab {font-family:Microsoft YaHei;}
        .mb{height: 32px;}
        .navcustom{
            font-family:Microsoft YaHei;
            text-align: center;
            color:#337AB7;
            width: 140px;
            margin-top: 5px;
            margin-left: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.067);
        }
/*//////////////////////////////////////Bootstrap Style*/
        .navcustom li{
            margin: 0;
            border-top: 1px solid #ddd;
        }
        .navcustom li:first-child{
            border-top: none;
        }
        .navcustom li a{
            margin: 0;
            padding: 8px 16px;
            border-radius: 0;
        }
        .navcustom li.active a, ul.nav-tabs li.active a:hover{
            color: #fff;
            background: #0088cc;
            border: 1px solid #0088cc;
        }
        .navcustom li:first-child a{
            border-radius: 4px 4px 0 0;
        }
        .navcustom li:last-child a{
            border-radius: 0 0 4px 4px;
        }
        .navcustom.affix{
            top: 30px; /* Set the top position of pinned element */
        }
    </style>
</head>

<body>
<ul id="myTab" class="nav nav-tabs">
    <li class="Tab"><a id='Tab1' href="#TabCanvas" data-toggle="tab">走势图</a></li>
    <li class="Tab dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
            说明书<b class="caret"></b>
        </a>
        <ul class="dropdown-menu">
           <li><a data-toggle="modal" href="#notice1">客户时效</a></li>
           <li class="divider"></li>
        </ul>
    </li>
</ul>

<div id="myTabContent" class="tab-content">
    <div class="tab-pane fade in active" id="TabCanvas">
        <div id='TrendCanvas' style="height:640px;"></div>
    </div>
    <div class="modal fade" id="notice1" tabindex="-1" role="dialog" 
       aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" 
                    data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                    客户时效说明
                    </h4>
                </div>
                <div class="modal-body">
                <dl>
                    <dt>取值逻辑</dt>
                    <dd>1 获取查询日期及之前一段时间的所有单号</dd>
                    <dd>2 根据单号提供的发件站点和签收站点信息，查询规定时效表确定该单应签收的时间</dd>
                    <dd>3 筛选应到达时间落在查询时间之内的单号</dd>
                    <dd>4 查找该单号的签收时间，与应签收时间对比，若超出范围，这认为时效未达成</dd>
                    <dt>时间节点</dt>
                    <dd>- 查询起始日期8:00至查询结束日期次日8:00</dd>
                    <dt>注意事项</dt>
                    <dd>- 汇总表、明细表中的数据以出发分拨或分公司为归集主体</dd>
                    <dd>- 数据实时更新，查询当日或前一日数据由于部分数据不全会偏高</dd>
                </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" 
                    data-dismiss="modal">     
                    我知道了
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>