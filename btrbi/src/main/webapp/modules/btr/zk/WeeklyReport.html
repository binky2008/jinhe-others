<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>快运周报</title>

    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../../tools/easyui/themes/icon.css">
    <link rel="stylesheet" type="text/css" href="../../dm/common.css">

    <script src="../../tools/easyui/jquery.min.js"></script>
    <script src="../../tools/easyui/jquery.easyui.min.js"></script>

    <script src="../../framework/core.js"></script>
    <script src="../../framework/ajax.js"></script>
    <script src="../../dm/common.js"></script>

    <script type="text/javascript">
    var MyColor = ['#5C0303','#D33C11','#EF4926','#F37A5A','#EF9728',
                '#EFC028','#7CC699','#00A272','#008972','#005E37','#005E37'],
        data = {rows:[],footer:[]},OrgList = [],CenterList = [],DayList = [],Relate = [];

    window.onload = function() {
        var originData = window.parent.globalValiable.data;
        Table(originData);
    }

    function Table(originData){
        var datat = [],title = document.getElementById('title'),
            id = 1,cList = [],dList = [],
            formatter = ["formatter","formatter","formatter","formatter","formatter2","formatter2","formatter2","formatter2"];
        for(var i = 0; i < originData.length; i++) {
            var iw = originData[i]["inweek"],
                week = originData[i]["week"],
                center = originData[i]["center_name"],
                org = originData[i]["org_name"];
            var d = iw + center,
                c = iw + org;

            if(!Relate.contains(iw)){
                Relate[iw] = week;
            }
            if(!Relate.contains(center)){
                Relate[center] = org;
            }
            if(!DayList.contains(iw)){
                DayList.push(iw);
                datat[iw] = {lr_tn:0,lr_n:0,dp_n:0,dp_tn:0,ts_n:0,ts_tn:0,at:0,et:0,cb:0,sb:0,cl:0,sl:0,p:0};
            }
            if(!OrgList.contains(org)){
                OrgList.push(org);
            }
            if(!CenterList.contains(center)){
                CenterList.push(center);
            }
            if(!cList.contains(c)){
                cList.push(c);
                datat[c] = {lr_tn:0,lr_n:0,dp_n:0,dp_tn:0,ts_n:0,ts_tn:0,at:0,et:0,cb:0,sb:0,cl:0,sl:0,p:0};
            }
            if(!dList.contains(d)){
                dList.push(d);
                datat[d] = {lr_tn:0,lr_n:0,dp_n:0,dp_tn:0,ts_n:0,ts_tn:0,at:0,et:0,cb:0,sb:0,cl:0,sl:0,p:0};
            }

            datat[c].ts_n += originData[i]["trans_n"];
            datat[c].ts_tn += originData[i]["trans_tn"];
            datat[c].lr_n += originData[i]["loadrate_n"];
            datat[c].lr_tn += originData[i]["loadrate_tn"];
            datat[c].dp_n += originData[i]["disp_n"];
            datat[c].dp_tn += originData[i]["disp_tn"];
            datat[c].at += originData[i]["actual_trans"];
            datat[c].et += originData[i]["expect_trans"];
            datat[c].cb += originData[i]["centerbroken"];
            datat[c].sb += originData[i]["sitebroken"];
            datat[c].cl += originData[i]["centerlost"];
            datat[c].sl += originData[i]["sitelost"];
            datat[c].p += originData[i]["pass"];

            datat[d].ts_n += originData[i]["trans_n"];
            datat[d].ts_tn += originData[i]["trans_tn"];
            datat[d].lr_n += originData[i]["loadrate_n"];
            datat[d].lr_tn += originData[i]["loadrate_tn"];
            datat[d].dp_n += originData[i]["disp_n"];
            datat[d].dp_tn += originData[i]["disp_tn"];
            datat[d].at += originData[i]["actual_trans"];
            datat[d].et += originData[i]["expect_trans"];
            datat[d].cb += originData[i]["centerbroken"];
            datat[d].sb += originData[i]["sitebroken"];
            datat[d].cl += originData[i]["centerlost"];
            datat[d].sl += originData[i]["sitelost"];
            datat[d].p += originData[i]["pass"];

            datat[iw].ts_n += originData[i]["trans_n"];
            datat[iw].ts_tn += originData[i]["trans_tn"];
            datat[iw].lr_n += originData[i]["loadrate_n"];
            datat[iw].lr_tn += originData[i]["loadrate_tn"];
            datat[iw].dp_n += originData[i]["disp_n"];
            datat[iw].dp_tn += originData[i]["disp_tn"];
            datat[iw].at += originData[i]["actual_trans"];
            datat[iw].et += originData[i]["expect_trans"];
            datat[iw].cb += originData[i]["centerbroken"];
            datat[iw].sb += originData[i]["sitebroken"];
            datat[iw].cl += originData[i]["centerlost"];
            datat[iw].sl += originData[i]["sitelost"];
            datat[iw].p += originData[i]["pass"];
        }

        for(var i = 0; i < DayList.length; i++){   
            title.innerHTML += '<th field="' + DayList[i] + '" width="110" align="right" formatter="formatter" styler="styler">' + Relate[DayList[i]] + '</th>';
        }

        id = Columns(datat,id,100,'业务完成率','at','et',false);
        id = Columns(datat,id,100,'装载率','lr_n','lr_tn',true);
        id = Columns(datat,id,100,'中转达成率','ts_n','ts_tn',true);
        id = Columns(datat,id,100,'派件时效达成率','dp_n','dp_tn',true);
        id = Columns(datat,id,100000,'中转遗失率','cl','p',false);
        id = Columns(datat,id,100000,'派送遗失率','sl','p',false);
        id = Columns(datat,id,100000,'中转破损率','cb','p',false);
        id = Columns(datat,id,100000,'派送破损率','sb','p',false);

        $('#Table').treegrid({
            idField:'id',
            treeField:'name',
            rownumbers: true,
            showFooter: true,
            animate: true,
            data: data
        });
    }

    function Columns(datat,id,e,name,t1,t2,type){
        var temp = [];
        for(var day in DayList){
            if(day != 'contains'){
                temp[DayList[day]] = Rate(datat[DayList[day]][t1],datat[DayList[day]][t2],e);
            }
        }
        temp.name = name;
        ID = id;
        temp.id = id++;
        temp.state = "closed";
        data.rows.push(temp);

        for(var c in OrgList){
            var temp = []
                cid = id;
            for(var day in DayList){
                if((day != 'contains')&&(c != 'contains')){              
                    var n = DayList[day] + OrgList[c];
                    if(datat[n] != undefined){
                        temp[DayList[day]] = Rate(datat[n][t1],datat[n][t2],e);
                    }
                    else{
                        temp[DayList[day]] = '';
                    }
                }
            }

            if(c != 'contains'){
                temp.name = OrgList[c];
                temp.id = id++;
                temp._parentId = ID;
                if(type){temp.state = "closed";}
                data.rows.push(temp);
            }

            for(var d in CenterList){
                var temp = [];
                    valve = false;
                if(d != 'contains'){
                    for(var day in DayList){
                        if(day != 'contains'){
                            var n = DayList[day] + CenterList[d];
                            if(Relate[CenterList[d]] == OrgList[c]){
                                valve = true;
                                if(datat[n] != undefined){
                                    temp[DayList[day]] = Rate(datat[n][t1],datat[n][t2],e);
                                }
                                else{
                                    temp[DayList[day]] = '';
                                }
                            }
                        }
                    }

                    if((valve)&&(type)){
                        temp.name = CenterList[d];
                        temp.id = id++;
                        temp._parentId = cid;
                        data.rows.push(temp);
                    }
                }    
            }
        }
        return id;
    }

    function styler(value,row,index){
        var name;
        if(row._parentId == undefined){
            name = row.name;
        }
        else if(data.rows[row._parentId-1]._parentId == undefined){
            name = data.rows[row._parentId-1].name;
        }
        else{
            name = data.rows[data.rows[row._parentId-1]._parentId-1].name;
        }
        
        if(['业务完成率','装载率','中转达成率','派件时效达成率'].contains(name)){
            var c = Math.floor(value/10);
            c = c > 10?10:c;
            return 'color:' + MyColor[c] +';font-weight:bold;';
        }
        else{
            return value > 0?'color:#C70B25;font-weight:bold;':'color:#389562;font-weight:bold;';
        }
    }

    function formatter(value, row, index){
        var name;
        if(row._parentId == undefined){
            name = row.name;
        }
        else if(data.rows[row._parentId-1]._parentId == undefined){
            name = data.rows[row._parentId-1].name;
        }
        else{
            name = data.rows[data.rows[row._parentId-1]._parentId-1].name;
        }
        
        if(['业务完成率','装载率','中转达成率','派件时效达成率'].contains(name)){
            if(name == '中转达成率'){value = value > 100?100:value;}
            return value === ''?'':formatMoney(value, 1) + '%'; 
        }
        else{
            return value === ''?'':formatMoney(value, 1);
        }
    }

    function formatMoney(s, n) {
       n = n > 0 && n <= 20 ? n : 2;   
       s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";   
       var l = s.split(".")[0].split("").reverse(),   
       r = s.split(".")[1];   
       t = "";   
       for(i = 0; i < l.length; i ++ ) {   
          t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");   
       }   
       return t.split("").reverse().join("") + "." + r;   
    } 

    function Rate(n,tn,e){
        return tn == 0?'':n/tn*e;
    }

    Array.prototype.contains = function(obj) {
        var i = this.length;  
        while (i--) {  
            if (this[i] === obj) {  
                return true;  
            }  
        }  
        return false;  
    } 
    </script>

    <style type="text/css">
        dt {font-family:Microsoft YaHei;font-size:20px;}
        dd {font-family:Microsoft YaHei;font-size:16px;text-indent:30px}
    </style>
</head>

<body>
    <div class="easyui-tabs" data-options='fit:true'>
        <div title="明细" class="easyui" data-options="fit:true">
            <table id="Table" >
                <thead frozen="true">
                    <tr id="title">
                        <th  id='detailtitle' field="name" width="200">名称</th>
                    </tr>
                </thead>
                <thead>
                    <tr id="cityColumn"></tr>
                </thead>
            </table>
        </div>
        <div title="说明书">
            <dl>
            <dt>计算公式</dt>
            <dd>- 业务完成率=实际货量完成值/所管辖区域目标货量</dd>
            <dd>- 装载率=实际装载货量/班线运行负荷载量</dd>
            <dd>- 中转达成率=实际中转件数/应中转件数</dd>
            <dd>- 派件时效达成率=规定时间内的实际派件数量/规定时间内的应派件数量</dd>
            <dd>- 遗失率=丢失货物件数/操作总件数</dd>
            <dd>- 破损率=累计破损货物件数/操作总件数</dd>
            <dt>时间节点</dt>
            <dd>- 业务完成率、派件时效达成率、破损率、遗失率：起始日期00:00至结束日期次日00:00</dd>
            <dd>- 装载率：起始日期12:00至结束日期次日12:00</dd>
            <dd>- 中转达成率：起始日期16:00至结束日期次日16:00</dd>
            <dt>注意事项</dt>
            <dd>- 装载率重量取值录单的实际重量，若录单重量错误，可能导致装载率错误</dd>
            </dl>
        </div>
    </div>
</body>
</html>